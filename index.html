<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã‚ã•ã®ã˜ã‚…ã‚“ã³ãƒã‚¹ã‚¿ãƒ¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            overflow: hidden;
            touch-action: manipulation;
            transition: background-color 0.3s ease;
        }

        /* æº–å‚™ã‚«ãƒ¼ãƒ‰ï¼šGridå†…ã§100%åºƒãŒã‚‹ */
        .card-container {
            perspective: 1000px;
            width: 100%;
            height: 100%;
            user-select: none;
            touch-action: none;
        }

        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            transform-style: preserve-3d;
            cursor: pointer;
        }

        .card-inner.is-flipped {
            transform: rotateY(180deg);
        }

        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 1.25rem;
            border-width: 4px;
            /* é•å’Œæ„Ÿã®ã‚ã‚‹å½±ã‚’æ¶ˆã—ã€ã‚½ãƒ•ãƒˆãªå½±ã«å¤‰æ›´ */
            box-shadow: 0 2px 8px -2px rgb(0 0 0 / 0.05);
        }

        .card-back {
            transform: rotateY(180deg);
        }

        .dragging {
            opacity: 0.5;
            scale: 0.95;
            z-index: 50;
        }

        @keyframes confetti {
            0% { transform: translateY(0) rotate(0); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
        .confetti {
            position: absolute;
            width: 10px; height: 10px;
            animation: confetti 3s ease-out forwards;
        }
        @keyframes shine {
            0%, 100% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.1); filter: brightness(1.3); }
        }
        .earned-stamp { animation: shine 2s infinite; }
    </style>
</head>
<body id="app-body" class="bg-blue-50 h-[100dvh] w-screen p-4 lg:p-6 text-slate-800">

    <div class="flex flex-col lg:flex-row h-full gap-4 lg:gap-6 overflow-hidden">
        
        <!-- å·¦å´ãƒ¡ã‚¤ãƒ³ï¼šã‚ã•ã®ã˜ã‚…ã‚“ã³ -->
        <div id="task-panel" class="flex-[2] min-h-0 bg-white rounded-[2rem] shadow-sm flex flex-col border-b-8 border-blue-200 order-2 lg:order-1 overflow-hidden p-4 lg:p-8">
            <div class="flex justify-between items-center mb-3 lg:mb-4 shrink-0 px-2">
                <div>
                    <h1 id="label-title" class="text-2xl lg:text-4xl font-black text-blue-600 leading-none">ã‚ã•ã®ã˜ã‚…ã‚“ã³</h1>
                    <div class="flex items-center gap-2 lg:gap-4 mt-2">
                        <div class="w-32 lg:w-64 h-3 lg:h-5 bg-gray-100 rounded-full overflow-hidden border-2 border-gray-50">
                            <div id="progress-bar" class="h-full bg-green-400 transition-all duration-500 ease-out" style="width: 0%"></div>
                        </div>
                        <span id="progress-text" class="font-bold text-xs lg:text-lg text-gray-400">0 / 0</span>
                    </div>
                </div>
                <button onclick="toggleSettings()" id="settings-btn" class="p-2 bg-gray-100 rounded-full hover:bg-gray-200 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                </button>
            </div>

            <!-- ã‚¿ã‚¹ã‚¯ã®ã‚°ãƒªãƒƒãƒ‰ (JSã§è¡Œæ•°ã‚’è¨ˆç®—ã—ã€1ç”»é¢ã«åã‚ã‚‹) -->
            <div id="task-grid" class="flex-1 min-h-0 grid grid-cols-3 gap-3 lg:gap-4 overflow-hidden content-stretch"></div>

            <!-- æ“ä½œã‚¨ãƒªã‚¢ -->
            <div class="mt-3 pt-3 border-t border-slate-50 flex justify-between items-center shrink-0">
                <div id="add-task-form" class="flex gap-2 items-center">
                    <input type="text" id="new-task-input" placeholder="ã‚¿ã‚¹ã‚¯ã‚’ã¤ã„ã‹" class="w-32 lg:w-48 px-3 py-1.5 border-2 border-slate-100 rounded-xl outline-none font-bold text-xs lg:text-sm focus:border-blue-200">
                    <button id="add-task-btn" onclick="addTask()" class="bg-blue-500 text-white p-1.5 rounded-xl active:scale-95 transition-all">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    </button>
                </div>
                <button id="reset-btn" onclick="resetAll()" class="flex items-center gap-1 text-slate-300 hover:text-slate-500 font-bold text-[10px] lg:text-xs">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></svg>
                    <span id="label-reset">ã‚„ã‚ŠãªãŠã™</span>
                </button>
            </div>
        </div>

        <!-- å³å´ï¼šæ™‚è¨ˆãƒ»ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ãƒ»ã‚¹ã‚¿ãƒ³ãƒ—ã‚«ãƒ¼ãƒ‰ (1/3ãšã¤å‡ç­‰) -->
        <div class="w-full lg:w-1/3 flex flex-row lg:flex-col gap-3 lg:gap-6 shrink-0 order-1 lg:order-2 h-full min-h-0">
            
            <!-- 1. æ™‚è¨ˆ -->
            <div id="clock-box" class="flex-1 bg-gradient-to-br from-blue-400 to-blue-500 rounded-[2rem] shadow-sm flex flex-col items-center justify-center text-white border-b-8 border-blue-600/20">
                <div id="digital-clock" class="text-4xl lg:text-7xl font-black tracking-tight leading-none drop-shadow-md">00:00</div>
                <div id="digital-seconds" class="text-lg lg:text-2xl font-bold opacity-80 mt-1">00</div>
            </div>

            <!-- 2. å‡ºç™ºã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ -->
            <div id="countdown-card" class="flex-1 bg-white rounded-[2rem] shadow-sm flex flex-col items-center justify-center border-t-8 lg:border-t-[10px] border-orange-400 relative overflow-hidden min-w-0">
                <div class="w-full flex flex-col items-center text-center">
                    <div id="label-remaining" class="text-orange-500 font-black text-xs lg:text-base mb-2 uppercase tracking-widest leading-none">ã—ã‚…ã£ã±ã¤ã¾ã§</div>
                    <div id="countdown-timer" class="text-xl md:text-3xl lg:text-5xl font-black text-slate-700 leading-none flex justify-center items-baseline gap-2 whitespace-nowrap tabular-nums">
                        ã‚ã¨ -- æ™‚é–“ -- åˆ†
                    </div>
                </div>
            </div>

            <!-- 3. ã‚¹ã‚¿ãƒ³ãƒ—ã‚«ãƒ¼ãƒ‰ (ç¸¦ã«ä¼¸ã³ãªã„ã‚ˆã†é«˜ã•ã‚’åˆ¶å¾¡) -->
            <div id="stamp-card" class="flex-1 bg-white rounded-[2rem] shadow-sm p-4 lg:p-6 flex flex-col justify-center border-t-8 lg:border-t-[10px] border-yellow-400 relative overflow-hidden min-w-0">
                <div class="flex justify-between items-center mb-2 lg:mb-3 px-1 shrink-0">
                    <span id="label-stamp" class="text-xs lg:text-lg font-black text-slate-400 uppercase tracking-wider">é€±é–“ã‚¹ã‚¿ãƒ³ãƒ—</span>
                    <div class="flex items-center gap-1 text-yellow-500 font-black text-base lg:text-xl">
                        ğŸ† <span id="perfect-count" class="tabular-nums">0</span>
                    </div>
                </div>
                <div id="stamp-row" class="flex-1 flex justify-between items-center gap-1 lg:gap-2 min-h-0 overflow-hidden">
                    <!-- JSã§å‹•çš„ã«ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </div>

    <!-- è¨­å®šç”»é¢ -->
    <div id="settings-overlay" class="fixed inset-0 z-[150] bg-slate-900/60 backdrop-blur-md hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-2xl rounded-[2.5rem] shadow-2xl flex flex-col max-h-[90vh] overflow-hidden border-b-8 border-slate-200">
            <div class="px-8 py-6 border-b flex justify-between items-center bg-slate-50 shrink-0">
                <h3 id="label-settings-title" class="text-2xl font-black text-slate-700 tracking-tight">âš™ï¸ ã›ã£ã¦ã„</h3>
                <button onclick="toggleSettings()" class="bg-white p-2 rounded-full shadow-sm border hover:bg-gray-100 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-6 lg:p-8 space-y-6 font-bold">
                <section class="bg-slate-50 p-4 rounded-2xl border-2 border-slate-100 flex items-center justify-between">
                    <span class="text-xl font-black text-slate-700">ã‹ã‚“ã˜ (æ¼¢å­—)</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="kanji-toggle" onchange="toggleKanji()" class="sr-only peer">
                        <div id="toggle-bg" class="w-14 h-7 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all"></div>
                    </label>
                </section>
                <section class="bg-slate-50 p-4 rounded-2xl border-2 border-slate-100">
                    <div id="label-theme-setting" class="text-[10px] font-black text-slate-400 mb-3 uppercase tracking-widest text-center">ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼</div>
                    <div class="grid grid-cols-4 gap-2">
                        <button onclick="changeTheme('blue')" class="h-12 rounded-xl bg-blue-500 border-2 border-white text-white text-xs font-black">ã‚ãŠ</button>
                        <button onclick="changeTheme('pink')" class="h-12 rounded-xl bg-rose-400 border-2 border-white text-white text-xs font-black">ã‚‚ã‚‚</button>
                        <button onclick="changeTheme('green')" class="h-12 rounded-xl bg-emerald-500 border-2 border-white text-white text-xs font-black">ã¿ã©ã‚Š</button>
                        <button onclick="changeTheme('orange')" class="h-12 rounded-xl bg-orange-500 border-2 border-white text-white text-xs font-black">ã ã„ã ã„</button>
                    </div>
                </section>
                <section class="bg-slate-50 p-4 rounded-2xl border-2 border-slate-100 text-center">
                    <div id="label-departure-setting" class="text-[10px] font-black text-slate-400 mb-2 uppercase tracking-widest">ã—ã‚…ã£ã±ã¤ ã˜ã‹ã‚“</div>
                    <input type="time" id="departure-input" value="08:00" onchange="updateDepartureTime()" class="w-full max-w-[200px] p-3 bg-white border-2 border-slate-200 rounded-xl text-4xl font-black text-center text-blue-600 outline-none">
                </section>
                <section class="bg-slate-50 p-4 rounded-2xl border-2 border-slate-100 text-center">
                    <div id="label-stamp-days" class="text-[10px] font-black text-slate-400 mb-2 uppercase tracking-widest">ã‚¹ã‚¿ãƒ³ãƒ—ã‚’é›†ã‚ã‚‹æ›œæ—¥</div>
                    <div id="day-toggle-list" class="flex flex-wrap justify-center gap-1"></div>
                </section>
                <section class="bg-slate-50 p-4 rounded-2xl border-2 border-slate-100">
                    <div id="label-alarm-setting" class="text-[10px] font-black text-slate-400 mb-2 text-center uppercase tracking-widest">ã‚¢ãƒ©ãƒ¼ãƒ </div>
                    <div id="alarm-list" class="grid grid-cols-2 lg:grid-cols-3 gap-2 text-xs"></div>
                </section>
                <div class="flex justify-center pt-2">
                    <button id="sound-test-btn" onclick="testSound()" class="bg-slate-800 text-white px-10 py-3 rounded-full font-black text-lg active:scale-95 transition-transform flex items-center gap-2">
                        <span id="label-sound-test">ğŸ”Š ãŠã¨ã‚’ãªã‚‰ã—ã¦ã¿ã‚‹</span>
                    </button>
                </div>
            </div>
            <div class="p-6 bg-slate-50 border-t flex justify-center shrink-0">
                <button id="close-settings-btn" onclick="toggleSettings()" class="bg-blue-600 text-white px-16 py-3 rounded-full font-black text-xl active:scale-95">è¨­å®šã‚’ãŠã‚ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- ãŠç¥ã„ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="celebration-overlay" class="fixed inset-0 z-[100] bg-[#fff0f3]/95 hidden flex flex-col items-center justify-center text-rose-600 p-6 text-center overflow-hidden">
        <div id="confetti-container" class="absolute inset-0 pointer-events-none"></div>
        <div class="relative z-10 flex flex-col items-center">
            <div id="celebration-title-box" class="bg-white rounded-[3rem] p-8 lg:p-16 shadow-lg mb-8 border-b-[12px] border-rose-100 text-rose-600">
                <h2 id="main-celebration-title" class="text-4xl lg:text-7xl font-black mb-4 tracking-tight">ã˜ã‚…ã‚“ã³ ã‹ã‚“ã‚Šã‚‡ã†ï¼</h2>
                <p id="main-celebration-desc" class="text-xl lg:text-3xl font-bold opacity-90 leading-relaxed">ã™ã”ã„ï¼ãœã‚“ã¶ ã§ããŸã­ï¼</p>
            </div>
            <button id="btn-celebration-ok" onclick="closeCelebration()" class="bg-rose-500 text-white px-20 py-5 rounded-full text-3xl lg:text-5xl font-black active:scale-95 transition-transform">ã¯ãƒ¼ã„ï¼</button>
        </div>
    </div>

    <!-- ã‚¢ãƒ©ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="alarm-overlay" class="fixed inset-0 z-[200] bg-orange-500 animate-pulse-theme hidden flex flex-col items-center justify-center text-white p-10 text-center">
        <div class="bg-white/20 rounded-full p-10 mb-8"><svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></div>
        <h2 id="alarm-title" class="text-5xl lg:text-8xl font-black mb-8 tracking-tight">ã‚ã¨ 10ãµã‚“ï¼</h2>
        <button onclick="closeAlarm()" id="btn-alarm-ok-box" class="bg-white text-orange-600 px-16 py-6 rounded-full text-3xl lg:text-5xl font-black shadow-lg active:scale-95 transition-transform">ã‚ã‹ã£ãŸï¼</button>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-8 py-4 rounded-full font-bold shadow-lg transition-all opacity-0 pointer-events-none transform translate-y-4 z-[250] text-sm text-center"></div>

    <script>
        const DICT = {
            kanji: {
                title: "æœã®æº–å‚™", remaining: "å‡ºç™ºã¾ã§", stamp_card: "é€±é–“ã‚¹ã‚¿ãƒ³ãƒ—", reset: "ã‚„ã‚ŠãªãŠã™",
                settings: "è¨­å®š", display_setting: "è¡¨ç¤ºè¨­å®š", theme_setting: "ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼",
                departure_setting: "å‡ºç™ºæ™‚é–“", stamp_days: "ã‚¹ã‚¿ãƒ³ãƒ—ã‚’é›†ã‚ã‚‹æ›œæ—¥", alarm_setting: "é€šçŸ¥è¨­å®š",
                sound_test: "ğŸ”Š éŸ³ã‚’é³´ã‚‰ã—ã¦ã¿ã‚‹", close_settings: "è¨­å®šã‚’çµ‚ã‚ã‚‹", done: "å®Œäº†ï¼",
                celebration_done: "æº–å‚™å®Œäº†ï¼", celebration_desc: "ã™ã”ã„ï¼å…¨éƒ¨ã§ããŸã­ï¼",
                go_out: "ã„ã£ã¦ã‚‰ã£ã—ã‚ƒã„ï¼", go_out_desc: "æ°—ã‚’ã¤ã‘ã¦è¡Œã£ã¦ãã¦ã­ï¼",
                perfect_week: "ğŸ† ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆï¼ ğŸ†", perfect_desc: "ã™ã”ã„ï¼ä¸€é€±é–“ã®æº–å‚™ã‚’ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆã—ãŸã‚ˆï¼",
                alarm_time: "å‡ºç™ºï¼", alarm_min: "åˆ†å‰", alarm_only_undone: "â€»æœªå®Œäº†æ™‚",
                days: ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'],
                task_map: { 'ã¯ã¿ãŒã': 'æ­¯ç£¨ã', 'ã‚ã•ã”ã¯ã‚“': 'æœé£Ÿ', 'ãƒˆã‚¤ãƒ¬': 'ãƒˆã‚¤ãƒ¬', 'ããŒãˆ': 'ç€æ›¿ãˆ', 'ãã¤ã—ãŸ': 'é´ä¸‹', 'ãƒ©ãƒ³ãƒ‰ã‚»ãƒ«': 'ãƒ©ãƒ³ãƒ‰ã‚»ãƒ«æº–å‚™', 'ã‹ã¿ã®ã‘': 'é«ªã®æ¯›', 'ã§ããŸï¼': 'å®Œäº†ï¼' }
            },
            kana: {
                title: "ã‚ã•ã®ã˜ã‚…ã‚“ã³", remaining: "ã—ã‚…ã£ã±ã¤ã¾ã§", stamp_card: "ã—ã‚…ã†ã‹ã‚“ã‚¹ã‚¿ãƒ³ãƒ—", reset: "ã‚„ã‚ŠãªãŠã™",
                settings: "ã›ã£ã¦ã„", display_setting: "ã²ã‚‡ã†ã˜ ã›ã£ã¦ã„", theme_setting: "ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼",
                departure_setting: "ã—ã‚…ã£ã±ã¤ ã˜ã‹ã‚“", stamp_days: "ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ã‚ã¤ã‚ã‚‹æ›œæ—¥", alarm_setting: "ã‚¢ãƒ©ãƒ¼ãƒ ",
                sound_test: "ğŸ”Š ãŠã¨ã‚’ãªã‚‰ã—ã¦ã¿ã‚‹", close_settings: "è¨­å®šã‚’ãŠã‚ã‚‹", done: "ã§ããŸï¼",
                celebration_done: "ã˜ã‚…ã‚“ã³ ã‹ã‚“ã‚Šã‚‡ã†ï¼", celebration_desc: "ã™ã”ã„ï¼ãœã‚“ã¶ ã§ããŸã­ï¼",
                go_out: "ã„ã£ã¦ã‚‰ã£ã—ã‚ƒã„ï¼", go_out_desc: "ãã‚’ã¤ã‘ã¦ ã„ã£ã¦ãã¦ã­ï¼",
                perfect_week: "ğŸ† ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆï¼ ğŸ†", perfect_desc: "ã™ã”ã„ï¼ä¸€é€±é–“ã®ã˜ã‚…ã‚“ã³ã‚’ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆã—ãŸã‚ˆï¼",
                alarm_time: "ã—ã‚…ã£ã±ã¤ï¼", alarm_min: "ãµã‚“ã¾ãˆ", alarm_only_undone: "â€»ã¾ã ã®ã¨ã",
                days: ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'],
                task_map: {}
            }
        };

        const THEMES = {
            blue: { body: 'bg-blue-50', primary: 'bg-blue-500', primaryDark: 'bg-blue-600', text: 'text-blue-600', border: 'border-blue-200', gradient: 'from-blue-400 to-blue-500', clockBorder: 'border-blue-600/20' },
            pink: { body: 'bg-rose-50', primary: 'bg-rose-400', primaryDark: 'bg-rose-500', text: 'text-rose-500', border: 'border-rose-200', gradient: 'from-rose-300 to-rose-400', clockBorder: 'border-rose-500/20' },
            green: { body: 'bg-emerald-50', primary: 'bg-emerald-500', primaryDark: 'bg-emerald-600', text: 'text-emerald-600', border: 'border-emerald-200', gradient: 'from-emerald-400 to-emerald-500', clockBorder: 'border-emerald-600/20' },
            orange: { body: 'bg-orange-50', primary: 'bg-orange-500', primaryDark: 'bg-orange-600', text: 'text-orange-600', border: 'border-orange-200', gradient: 'from-orange-400 to-orange-500', clockBorder: 'border-orange-600/20' }
        };

        const DEFAULT_TASKS = [
            { id: 1, text: 'ã¯ã¿ãŒã', completed: false }, { id: 2, text: 'ã‚ã•ã”ã¯ã‚“', completed: false },
            { id: 3, text: 'ãƒˆã‚¤ãƒ¬', completed: false }, { id: 4, text: 'ããŒãˆ', completed: false },
            { id: 5, text: 'ãã¤ã—ãŸ', completed: false }, { id: 6, text: 'ãƒ©ãƒ³ãƒ‰ã‚»ãƒ«', completed: false },
            { id: 7, text: 'ã‹ã¿ã®ã‘', completed: false }
        ];

        let tasks = [];
        let departureTime = "08:00";
        let isSettingsMode = false;
        let lastDateString = new Date().toDateString(); 
        let alarmConfig = { 30: true, 20: true, 10: true, 5: true, 0: true };
        let lastAlarmTriggered = ""; 
        let draggedItemIndex = null;
        let celebrationShownToday = false; 
        let enabledDays = [false, true, true, true, true, true, false]; 
        let stamps = [false, false, false, false, false, false, false];
        let perfectWeekCount = 0;
        let useKanji = false;
        let theme = 'blue';

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function safeUpdate(id, text) {
            const el = document.getElementById(id);
            if (el) el.textContent = text;
        }

        window.onload = () => {
            loadFromStorage();
            applyTheme();
            updateUIStrings();
            renderTasks();
            renderAlarmSettings();
            renderDayToggles();
            renderStamps();
            startClock();
            document.getElementById('new-task-input')?.addEventListener('keypress', (e) => { if (e.key === 'Enter') addTask(); });
            window.addEventListener('resize', renderTasks);
        };

        function t(key) { return DICT[useKanji ? 'kanji' : 'kana'][key] || key; }
        function taskT(name) { return useKanji ? (DICT.kanji.task_map[name] || name) : name; }

        function toggleKanji() {
            useKanji = document.getElementById('kanji-toggle').checked;
            updateUIStrings(); renderTasks(); renderAlarmSettings(); renderDayToggles(); renderStamps(); saveToStorage();
        }

        function changeTheme(newTheme) {
            theme = newTheme; applyTheme(); renderTasks(); renderDayToggles(); renderAlarmSettings(); saveToStorage();
        }

        function applyTheme() {
            const config = THEMES[theme];
            document.getElementById('app-body').className = `${config.body} h-[100dvh] w-screen p-4 lg:p-6 text-slate-800 transition-colors duration-300`;
            document.getElementById('clock-box').className = `flex-1 bg-gradient-to-br ${config.gradient} rounded-[2rem] shadow-sm flex flex-col items-center justify-center text-white border-b-8 ${config.clockBorder}`;
            document.getElementById('task-panel').className = `flex-[2] min-h-0 bg-white rounded-[2rem] shadow-sm flex flex-col border-b-[10px] ${config.border} p-4 lg:p-8`;
            document.getElementById('label-title').className = `text-xl lg:text-4xl font-black ${config.text} lg:mb-2 leading-none`;
            document.getElementById('add-task-btn').className = `${config.primary} text-white p-2 rounded-xl transition-all active:scale-95`;
            document.getElementById('close-settings-btn').className = `${config.primary} text-white px-16 py-3 rounded-full font-black text-xl shadow-lg active:scale-95 transition-all`;
            const toggle = document.getElementById('toggle-bg');
            if(toggle) toggle.style.backgroundColor = document.getElementById('kanji-toggle').checked ? config.primary.replace('bg-', '') : '';
        }

        function updateUIStrings() {
            safeUpdate('label-title', t('title'));
            safeUpdate('label-remaining', t('remaining'));
            safeUpdate('label-stamp', t('stamp_card'));
            safeUpdate('label-reset', t('reset'));
            safeUpdate('label-settings-title', t('settings'));
            safeUpdate('label-theme-setting', t('theme_setting'));
            safeUpdate('label-departure-setting', t('departure_setting'));
            safeUpdate('label-stamp-days', t('stamp_days'));
            safeUpdate('label-alarm-setting', t('alarm_setting'));
            safeUpdate('label-sound-test', t('sound_test'));
            safeUpdate('close-settings-btn', t('close_settings'));
            safeUpdate('btn-alarm-ok-box', useKanji ? "äº†è§£" : "ã‚ã‹ã£ãŸï¼");
            safeUpdate('btn-celebration-ok', useKanji ? "äº†è§£" : "ã¯ãƒ¼ã„ï¼");
            const toggle = document.getElementById('kanji-toggle'); if(toggle) toggle.checked = useKanji;
            const depInput = document.getElementById('departure-input'); if(depInput) depInput.value = departureTime;
        }

        function saveToStorage() {
            const data = { tasks, departureTime, saveDate: new Date().toDateString(), alarmConfig, celebrationShownToday, enabledDays, stamps, perfectWeekCount, useKanji, theme };
            localStorage.setItem('morning_routine_v3_data', JSON.stringify(data));
        }

        function loadFromStorage() {
            const savedData = localStorage.getItem('morning_routine_v3_data');
            if (savedData) {
                try {
                    const parsed = JSON.parse(savedData);
                    const today = new Date().toDateString();
                    if (parsed.saveDate !== today) { tasks = (parsed.tasks || DEFAULT_TASKS).map(t => ({ ...t, completed: false })); celebrationShownToday = false; } 
                    else { tasks = parsed.tasks || DEFAULT_TASKS; celebrationShownToday = parsed.celebrationShownToday || false; }
                    departureTime = parsed.departureTime || "08:00"; alarmConfig = parsed.alarmConfig || alarmConfig; enabledDays = parsed.enabledDays || enabledDays; stamps = parsed.stamps || stamps; perfectWeekCount = parsed.perfectWeekCount || 0; useKanji = parsed.useKanji || false; theme = parsed.theme || 'blue';
                    safeUpdate('perfect-count', perfectWeekCount);
                } catch (e) { tasks = DEFAULT_TASKS; }
            } else { tasks = DEFAULT_TASKS; }
        }

        function playBeep(freq = 880, duration = 0.1, delay = 0) {
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = 'square'; osc.frequency.setValueAtTime(freq, audioCtx.currentTime + delay); gain.gain.setValueAtTime(0.1, audioCtx.currentTime + delay); gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + delay + duration); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(audioCtx.currentTime + delay); osc.stop(audioCtx.currentTime + delay + duration);
        }

        function speakText(text) { if ('speechSynthesis' in window) { const uttr = new SpeechSynthesisUtterance(text); uttr.lang = 'ja-JP'; uttr.rate = 1.1; window.speechSynthesis.speak(uttr); } }

        function startClock() {
            setInterval(() => {
                const now = new Date(); if (now.toDateString() !== lastDateString) { if (now.getDay() === 1) { stamps = stamps.map(() => false); } lastDateString = now.toDateString(); celebrationShownToday = false; resetAll(); }
                document.getElementById('digital-clock').textContent = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                document.getElementById('digital-seconds').textContent = String(now.getSeconds()).padStart(2, '0');
                updateCountdown(now); checkAlarms(now);
            }, 1000);
        }

        function checkAlarms(now) {
            const [depH, depM] = departureTime.split(':').map(Number); const target = new Date(now); target.setHours(depH, depM, 0, 0); if (target < now) target.setDate(target.getDate() + 1);
            const diffMins = Math.floor((target - now) / 60000); const isAllDone = tasks.length > 0 && tasks.every(t => t.completed);
            [30, 20, 10, 5, 0].forEach(point => { if (diffMins === point && alarmConfig[point]) { const triggerId = `${now.getHours()}:${now.getMinutes()}:${point}`; if (lastAlarmTriggered === triggerId) return; if ([30, 20, 10].includes(point) && isAllDone) return; lastAlarmTriggered = triggerId; showAlarm(point); } });
        }

        function showAlarm(point) {
            const overlay = document.getElementById('alarm-overlay'); const title = document.getElementById('alarm-title'); for(let i=0; i<3; i++) playBeep(880, 0.1, i * 0.2);
            if (point === 0) { title.textContent = t('alarm_time'); speakText(useKanji ? "å‡ºç™ºã®æ™‚é–“ã§ã™ï¼å¿˜ã‚Œç‰©ã¯ã‚ã‚Šã¾ã›ã‚“ã‹ï¼Ÿ" : "ã—ã‚…ã£ã±ã¤ã® ã˜ã‹ã‚“ã ã‚ˆï¼ã‚ã™ã‚Œã‚‚ã®ã¯ãªã„ã‹ãªï¼Ÿ"); }
            else { title.textContent = `ã‚ã¨ ${point}${t('alarm_min')}`; speakText(useKanji ? `å‡ºç™ºã¾ã§ã‚ã¨${point}åˆ†ã§ã™ã€‚æº–å‚™ã‚’é€²ã‚ã¾ã—ã‚‡ã†ï¼` : `ã—ã‚…ã£ã±ã¤ã¾ã§ ã‚ã¨${point}ãµã‚“ã ã‚ˆã€‚ã˜ã‚…ã‚“ã³ã‚’ã™ã™ã‚ã‚ˆã†ï¼`); }
            overlay.classList.remove('hidden');
        }

        function closeAlarm() { document.getElementById('alarm-overlay').classList.add('hidden'); window.speechSynthesis.cancel(); }
        function testSound() { audioCtx.resume(); for(let i=0; i<3; i++) playBeep(880, 0.1, i * 0.2); speakText(useKanji ? "ãƒ†ã‚¹ãƒˆæˆåŠŸï¼éŸ³ãŒèã“ãˆã¾ã™ã‹ï¼Ÿ" : "ãƒ†ã‚¹ãƒˆã›ã„ã“ã†ï¼ãŠã¨ãŒãã“ãˆã‚‹ã‹ãªï¼Ÿ"); }

        function updateCountdown(now) {
            const [depH, depM] = departureTime.split(':').map(Number); const target = new Date(now); target.setHours(depH, depM, 0, 0); if (target < now) target.setDate(target.getDate() + 1);
            const diff = target - now; const timerElement = document.getElementById('countdown-timer');
            if (diff <= 0 || (target - now) < 1000) { timerElement.innerHTML = `<span class="text-red-500 animate-bounce">${t('alarm_time')}</span>`; } 
            else {
                const totalSecs = Math.floor(diff / 1000); const h = Math.floor(totalSecs / 3600); const m = Math.ceil((totalSecs % 3600) / 60); 
                let html = `<span class="text-[0.6em] mr-2 opacity-50 font-black uppercase tracking-widest leading-none">ã‚ã¨</span>`;
                if (h > 0) html += `<span class="${THEMES[theme].text}">${h}</span><span class="text-[0.5em] mx-1 font-black leading-none">${useKanji ? 'æ™‚é–“':'ã˜ã‹ã‚“'}</span>`;
                html += `<span class="${THEMES[theme].text}">${m}</span><span class="text-[0.5em] mx-1 font-black leading-none">${useKanji ? 'åˆ†':'ãµã‚“'}</span>`;
                timerElement.innerHTML = html;
            }
        }

        function renderTasks() {
            const grid = document.getElementById('task-grid'); grid.innerHTML = '';
            const config = THEMES[theme];
            const rows = Math.ceil(tasks.length / 3);
            grid.style.gridTemplateRows = `repeat(${rows}, 1fr)`;
            
            tasks.forEach((task, index) => {
                const card = document.createElement('div'); card.className = 'card-container'; card.setAttribute('data-index', index);
                card.addEventListener('touchstart', (e) => { draggedItemIndex = index; e.currentTarget.classList.add('dragging'); }, {passive: true});
                card.addEventListener('touchend', (e) => {
                    e.currentTarget.classList.remove('dragging'); const touch = e.changedTouches[0]; const targetEl = document.elementFromPoint(touch.clientX, touch.clientY); const targetCard = targetEl?.closest('.card-container');
                    if (targetCard && draggedItemIndex !== null) { const targetIndex = parseInt(targetCard.getAttribute('data-index')); if (draggedItemIndex !== targetIndex) { const item = tasks.splice(draggedItemIndex, 1)[0]; tasks.splice(targetIndex, 0, item); saveToStorage(); renderTasks(); } } draggedItemIndex = null;
                });
                card.innerHTML = `
                    <div class="card-inner ${task.completed ? 'is-flipped' : ''}" onclick="toggleTask(${task.id})">
                        <div class="card-front bg-white ${config.border} ${config.text} border-2">
                            <span class="text-sm lg:text-xl font-black px-1 text-center pointer-events-none break-all">${taskT(task.text)}</span>
                            ${isSettingsMode ? `<button onclick="event.stopPropagation(); deleteTask(${task.id})" class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full p-1 z-20"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>` : ''}
                        </div>
                        <div class="card-back bg-green-100 border-green-400 text-green-700 border-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" class="text-green-500 mb-1"><polyline points="20 6 9 17 4 12"></polyline></svg>
                            <span class="text-[10px] lg:text-base font-black">${t('done')}</span>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
            updateProgress();
        }

        function renderStamps() {
            const container = document.getElementById('stamp-row'); container.innerHTML = '';
            const daysLabels = t('days');
            [1, 2, 3, 4, 5, 6, 0].forEach(d => {
                if (!enabledDays[d]) return;
                const earned = stamps[d]; const div = document.createElement('div');
                // ç¸¦é•·ã«ãªã‚‰ãªã„ã‚ˆã†ã€é«˜ã•ã‚’æŠ‘ãˆã¦æ¨ªã®ãƒãƒ©ãƒ³ã‚¹ã‚’å–ã‚‹
                div.className = `flex-1 flex flex-col items-center p-1 lg:p-2 rounded-xl border ${earned ? 'bg-yellow-50 border-yellow-200' : 'bg-gray-50 border-gray-100'} h-[70%] justify-center min-w-0 transition-all flex-shrink`;
                div.innerHTML = `<span class="text-[8px] lg:text-xs font-black ${earned ? 'text-yellow-600' : 'text-gray-400'} mb-1">${daysLabels[d]}</span><span class="text-2xl lg:text-4xl ${earned ? 'earned-stamp' : 'opacity-10 grayscale'}">${earned ? 'ğŸŒŸ' : 'â—¯'}</span>`;
                container.appendChild(div);
            });
        }

        function renderDayToggles() {
            const container = document.getElementById('day-toggle-list'); if(!container) return; container.innerHTML = '';
            const daysLabels = t('days'); const config = THEMES[theme];
            [1, 2, 3, 4, 5, 6, 0].forEach(d => {
                const active = enabledDays[d]; const btn = document.createElement('button');
                btn.className = `p-1 rounded-lg text-[10px] lg:text-xs font-black border-2 transition-all ${active ? (config.primary + ' text-white ' + config.primaryDark.replace('bg-','border-')) : 'bg-white text-slate-400 border-slate-100'}`;
                btn.textContent = daysLabels[d]; btn.onclick = () => { enabledDays[d] = !enabledDays[d]; renderDayToggles(); renderStamps(); saveToStorage(); };
                container.appendChild(btn);
            });
        }

        function renderAlarmSettings() {
            const list = document.getElementById('alarm-list'); if(!list) return; list.innerHTML = '';
            const minLabel = t('alarm_min'); const undoneLabel = t('alarm_only_undone');
            [30, 20, 10, 5, 0].forEach(p => {
                const active = alarmConfig[p]; const item = document.createElement('div');
                item.className = `flex items-center justify-between px-2 py-1 rounded-xl border-2 transition-all cursor-pointer ${active ? 'bg-white border-orange-300 shadow-sm' : 'bg-white border-slate-100 opacity-60'}`;
                item.onclick = () => { alarmConfig[p] = !alarmConfig[p]; renderAlarmSettings(); saveToStorage(); };
                const label = p === 0 ? t('alarm_time') : `${p}${minLabel}`;
                item.innerHTML = `<div class="flex flex-col"><span class="font-black text-[10px] lg:text-xs ${active ? 'text-orange-600' : 'text-slate-400'}">${label}</span>${[30, 20, 10].includes(p) ? `<span class="text-[8px] text-slate-300 font-bold">${undoneLabel}</span>` : ''}</div><div class="text-sm lg:text-base">${active ? 'ğŸ””' : 'ğŸ”•'}</div>`;
                list.appendChild(item);
            });
        }

        function updateProgress() {
            const completed = tasks.filter(t => t.completed).length; const total = tasks.length; const percent = total > 0 ? (completed / total) * 100 : 0;
            const bar = document.getElementById('progress-bar'); if(bar) bar.style.width = `${percent}%`; 
            safeUpdate('progress-text', `${completed} / ${total}`);
            if (total > 0 && completed === total && !isSettingsMode && !celebrationShownToday) { celebrationShownToday = true; handleCompletion(); }
        }

        function handleCompletion() {
            const now = new Date(); const todayIdx = now.getDay(); const [depH, depM] = departureTime.split(':').map(Number);
            const todayLimit = new Date(now); todayLimit.setHours(depH, depM, 0, 0);
            let isPerfectWeek = false; const isOnTime = now < todayLimit;
            if (enabledDays[todayIdx] && isOnTime) { if (!stamps[todayIdx]) { stamps[todayIdx] = true; const req = enabledDays.filter(d => d).length; const ern = stamps.filter((s, i) => s && enabledDays[i]).length; if (req === ern) { isPerfectWeek = true; perfectWeekCount++; safeUpdate('perfect-count', perfectWeekCount); } } }
            renderStamps(); saveToStorage(); showCelebration(isPerfectWeek, isOnTime);
        }

        function showCelebration(isPerfect, isOnTime) {
            const overlay = document.getElementById('celebration-overlay'); const title = document.getElementById('main-celebration-title'); const desc = document.getElementById('main-celebration-desc'); const box = document.getElementById('celebration-title-box');
            if (isPerfect) { title.textContent = t('perfect_week'); desc.textContent = t('perfect_desc'); box.className = "bg-yellow-400 rounded-[3rem] p-10 lg:p-20 shadow-lg mb-8 text-white border-b-8 border-yellow-500"; speakText(useKanji ? "å®Œç’§ã§ã™ï¼ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆé”æˆï¼ä¸€é€±é–“ã®æº–å‚™ãŒå®Œäº†ã—ã¾ã—ãŸï¼" : "ã™ã”ã„ï¼ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆé”æˆï¼ä¸€é€±é–“ã®ã˜ã‚…ã‚“ã³ã‚’ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆã—ãŸã‚ˆï¼"); } 
            else if (isOnTime) { title.textContent = t('celebration_done'); desc.textContent = t('celebration_desc'); box.className = "bg-white rounded-[3rem] p-10 lg:p-20 shadow-lg mb-8 border-b-8 border-rose-100 text-rose-600"; speakText(useKanji ? "æº–å‚™å®Œäº†ã§ã™ï¼ã™ã”ã„ã§ã™ã­ã€‚ã‚†ã£ãã‚Šéã”ã—ã¦ãã ã•ã„ã€‚" : "ã˜ã‚…ã‚“ã³ ã‹ã‚“ã‚Šã‚‡ã†ï¼ã™ã”ã„ã­ã€‚ã‚†ã£ãã‚Šã™ã”ã—ã¦ã­ã€‚"); }
            else { title.textContent = t('go_out'); desc.textContent = t('go_out_desc'); box.className = "bg-white rounded-[3rem] p-10 lg:p-20 shadow-lg mb-8 border-b-8 border-rose-100 text-rose-600"; speakText(useKanji ? "ã„ã£ã¦ã‚‰ã£ã—ã‚ƒã„ï¼æ°—ã‚’ã¤ã‘ã¦è¡Œã£ã¦ãã¦ã­ï¼" : "ã„ã£ã¦ã‚‰ã£ã—ã‚ƒã„ï¼ãã‚’ã¤ã‘ã¦ ã„ã£ã¦ãã¦ã­ï¼"); }
            const container = document.getElementById('confetti-container'); container.innerHTML = '';
            for (let i = 0; i < 60; i++) { const c = document.createElement('div'); c.className = 'confetti'; c.style.left = Math.random() * 100 + 'vw'; c.style.backgroundColor = ['#f472b6', '#fb7185', '#fbbf24', '#60a5fa', '#a78bfa'][Math.floor(Math.random() * 5)]; c.style.animationDelay = Math.random() * 3 + 's'; c.style.width = '10px'; c.style.height = '10px'; container.appendChild(c); }
            overlay?.classList.remove('hidden');
        }

        function closeCelebration() { document.getElementById('celebration-overlay')?.classList.add('hidden'); }
        function toggleTask(id) { if (draggedItemIndex !== null) return; const task = tasks.find(t => t.id === id); if (task) { task.completed = !task.completed; if (!task.completed) celebrationShownToday = false; audioCtx.resume(); playBeep(task.completed ? 1100 : 440, 0.05); renderTasks(); saveToStorage(); } }
        function addTask() { const input = document.getElementById('new-task-input'); const text = input?.value.trim(); if (text) { tasks.push({ id: Date.now(), text, completed: false }); celebrationShownToday = false; if(input) input.value = ''; renderTasks(); saveToStorage(); } }
        function deleteTask(id) { tasks = tasks.filter(t => t.id !== id); renderTasks(); saveToStorage(); }
        function resetAll() { tasks = tasks.map(t => ({ ...t, completed: false })); renderTasks(); saveToStorage(); }
        function updateDepartureTime() { departureTime = document.getElementById('departure-input')?.value || departureTime; saveToStorage(); }
        
        function toggleSettings() {
            isSettingsMode = !isSettingsMode;
            const overlay = document.getElementById('settings-overlay');
            const btn = document.getElementById('settings-btn');
            const config = THEMES[theme];
            if (isSettingsMode) {
                overlay?.classList.remove('hidden');
                if(btn) btn.className = `p-2 ${config.primary} text-white rounded-full transition-colors shadow-lg`;
            } else {
                overlay?.classList.add('hidden');
                if(btn) btn.className = `p-2 bg-gray-100 rounded-full hover:bg-gray-200 transition-colors`;
            }
            renderTasks();
        }

        function showToast(msg) { const t = document.getElementById('toast'); if(!t) return; t.textContent = msg; t.classList.remove('opacity-0', 'translate-y-4', 'pointer-events-none'); setTimeout(() => t.classList.add('opacity-0', 'translate-y-4', 'pointer-events-none'), 3000); }
    </script>
</body>
</html>
