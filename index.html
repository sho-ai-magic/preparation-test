<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>„ÅÇ„Åï„ÅÆ„Åò„ÇÖ„Çì„Å≥„Éû„Çπ„Çø„Éº</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            overflow: hidden;
            touch-action: manipulation;
            transition: background-color 0.3s ease;
        }

        /* Ê∫ñÂÇô„Ç´„Éº„ÉâÔºöGridÂÜÖ„Åß100%Â∫É„Åå„Çã */
        .card-container {
            perspective: 1000px;
            width: 100%;
            height: 100%;
            user-select: none;
            touch-action: none;
        }

        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            transform-style: preserve-3d;
            cursor: pointer;
        }

        .card-inner.is-flipped {
            transform: rotateY(180deg);
        }

        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 1.25rem;
            border-width: 3px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }

        .card-back {
            transform: rotateY(180deg);
        }

        .dragging {
            opacity: 0.5;
            scale: 0.95;
            z-index: 50;
        }

        @keyframes confetti {
            0% { transform: translateY(0) rotate(0); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
        .confetti {
            position: absolute;
            width: 10px; height: 10px;
            animation: confetti 3s ease-out forwards;
        }
        @keyframes shine {
            0%, 100% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.1); filter: brightness(1.3); }
        }
        .earned-stamp { animation: shine 2s infinite; }
    </style>
</head>
<body id="app-body" class="bg-blue-50 h-[100dvh] w-screen p-4 lg:p-5 text-slate-800 transition-colors duration-300">

    <div class="flex flex-col lg:flex-row h-full gap-4 lg:gap-5 overflow-hidden">
        
        <!-- Â∑¶ÂÅ¥„É°„Ç§„É≥Ôºö„ÅÇ„Åï„ÅÆ„Åò„ÇÖ„Çì„Å≥Ôºà1ÁîªÈù¢Âõ∫ÂÆöÔºâ -->
        <div id="task-panel" class="flex-[1.8] min-h-0 bg-white rounded-[2rem] shadow-sm flex flex-col order-2 lg:order-1 overflow-hidden p-5 lg:p-6 border border-slate-100">
            <div class="flex justify-between items-center mb-4 shrink-0 px-2">
                <div>
                    <h1 id="label-title" class="text-2xl lg:text-4xl font-black text-blue-600 leading-none">„ÅÇ„Åï„ÅÆ„Åò„ÇÖ„Çì„Å≥</h1>
                    <div class="flex items-center gap-3 mt-3">
                        <div class="w-32 lg:w-64 h-3 lg:h-5 bg-slate-100 rounded-full overflow-hidden border">
                            <div id="progress-bar" class="h-full bg-green-400 transition-all duration-500 ease-out" style="width: 0%"></div>
                        </div>
                        <span id="progress-text" class="font-bold text-sm lg:text-xl text-slate-400">0 / 0</span>
                    </div>
                </div>
                <button onclick="toggleSettings()" id="settings-btn" class="p-3 bg-slate-50 text-slate-400 rounded-full hover:bg-slate-100 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                </button>
            </div>

            <!-- „Çø„Çπ„ÇØ„ÅÆ„Ç∞„É™„ÉÉ„Éâ (1ÁîªÈù¢„Å´Âèé„Åæ„Çã„Çà„ÅÜÈÖçÁΩÆ) -->
            <div id="task-grid" class="flex-1 min-h-0 grid grid-cols-3 gap-3 lg:gap-4 overflow-hidden content-stretch pb-1"></div>

            <!-- Êìç‰Ωú„Ç®„É™„Ç¢ -->
            <div class="mt-4 pt-4 border-t border-slate-50 flex justify-between items-center shrink-0">
                <div id="add-task-form" class="flex gap-2 items-center">
                    <input type="text" id="new-task-input" placeholder="„Çø„Çπ„ÇØ„Çí„Å§„ÅÑ„Åã" class="w-40 lg:w-64 px-4 py-2 bg-slate-50 border-2 border-slate-100 rounded-xl outline-none font-bold text-sm lg:text-base focus:border-blue-200 transition-all">
                    <button id="add-task-btn" onclick="addTask()" class="bg-blue-500 text-white p-2 rounded-xl active:scale-95 transition-all">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    </button>
                </div>
                <button id="reset-btn" onclick="resetAll()" class="flex items-center gap-2 text-slate-300 hover:text-slate-500 font-black text-xs lg:text-base transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></svg>
                    <span id="label-reset">„ÇÑ„Çä„Å™„Åä„Åô</span>
                </button>
            </div>
        </div>

        <!-- Âè≥ÂÅ¥ÔºöÊôÇË®à Ôºã „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥ Ôºã „Çπ„Çø„É≥„ÉóÔºàÂùáÁ≠âÂàÜÂâ≤Ôºâ -->
        <div class="w-full lg:w-1/3 flex flex-row lg:flex-col gap-4 lg:gap-5 shrink-0 order-1 lg:order-2 h-full min-h-0">
            
            <!-- 1. ÊôÇË®à -->
            <div id="clock-box" class="flex-1 bg-gradient-to-br from-blue-400 to-blue-500 rounded-[2.5rem] flex flex-col items-center justify-center text-white border-b-4 border-blue-600/10 shadow-sm">
                <div id="digital-clock" class="text-5xl lg:text-8xl font-black tracking-tight leading-none">00:00</div>
                <div id="digital-seconds" class="text-xl lg:text-3xl font-bold opacity-80 mt-2 tabular-nums">00</div>
            </div>

            <!-- 2. Âá∫Áô∫„Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥ -->
            <div id="countdown-card" class="flex-1 bg-white rounded-[2.5rem] flex flex-col items-center justify-center relative overflow-hidden min-w-0 border border-slate-100 shadow-sm">
                <div class="w-full flex flex-col items-center text-center">
                    <div id="label-remaining" class="text-orange-500 font-black text-sm lg:text-xl mb-4 uppercase tracking-widest leading-none">„Åó„ÇÖ„Å£„Å±„Å§„Åæ„Åß</div>
                    <div id="countdown-timer" class="text-2xl md:text-4xl lg:text-6xl font-black text-slate-700 leading-none flex justify-center items-baseline gap-2 whitespace-nowrap tabular-nums">
                        „ÅÇ„Å® -- ÊôÇÈñì -- ÂàÜ
                    </div>
                </div>
            </div>

            <!-- 3. „Çπ„Çø„É≥„Éó„Ç´„Éº„Éâ -->
            <div id="stamp-card" class="flex-1 bg-white rounded-[2.5rem] p-5 lg:p-8 flex flex-col justify-center relative overflow-hidden min-w-0 border border-slate-100 shadow-sm">
                <div class="flex justify-between items-center mb-4 px-2 shrink-0">
                    <span id="label-stamp" class="text-xs lg:text-xl font-black text-slate-400 uppercase tracking-wider">ÈÄ±Èñì„Çπ„Çø„É≥„Éó</span>
                    <div class="flex items-center gap-2 text-yellow-500 font-black text-sm lg:text-2xl">
                        üèÜ <span id="perfect-count" class="tabular-nums">0</span>
                    </div>
                </div>
                <div id="stamp-row" class="flex-1 flex justify-between items-center gap-2 lg:gap-4 px-1 min-h-0 overflow-hidden">
                    <!-- JS„ÅßÂãïÁöÑ„Å´ÁîüÊàê -->
                </div>
            </div>
        </div>
    </div>

    <!-- Ë®≠ÂÆöÁîªÈù¢ (1ÁîªÈù¢„Åß„Åô„Åπ„Å¶„ÅÆÈ†ÖÁõÆ„ÅåË¶ã„Åà„Çã) -->
    <div id="settings-overlay" class="fixed inset-0 z-[150] bg-slate-900/60 backdrop-blur-md hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-5xl rounded-[3rem] shadow-2xl flex flex-col max-h-[90vh] overflow-hidden border border-slate-100">
            <!-- „Éò„ÉÉ„ÉÄ„Éº -->
            <div class="px-10 py-8 border-b flex justify-between items-center shrink-0">
                <h3 id="label-settings-title" class="text-3xl font-black text-slate-800 tracking-tight">„Åõ„Å£„Å¶„ÅÑ</h3>
                <button onclick="toggleSettings()" class="bg-slate-100 p-2 rounded-full hover:bg-slate-200 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="text-slate-400"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            
            <!-- Ë®≠ÂÆöÈ†ÖÁõÆ„Ç®„É™„Ç¢ -->
            <div class="flex-1 overflow-y-auto p-10 grid grid-cols-1 lg:grid-cols-2 gap-12 font-bold text-slate-700">
                
                <!-- Â∑¶„Çª„ÇØ„Ç∑„Éß„É≥ -->
                <div class="space-y-12">
                    <section>
                        <div id="label-display-setting" class="text-xl lg:text-2xl font-black mb-6 text-slate-400 uppercase tracking-widest border-l-8 border-blue-400 pl-4">„Å≤„Çá„ÅÜ„Åò „Åõ„Å£„Å¶„ÅÑ</div>
                        <div class="flex items-center justify-between bg-slate-50 p-6 rounded-3xl">
                            <span class="text-2xl font-black">„Åã„Çì„Åò (Êº¢Â≠ó)</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="kanji-toggle" onchange="toggleKanji()" class="sr-only peer">
                                <div id="toggle-bg" class="w-16 h-8 bg-slate-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[4px] after:left-[4px] after:bg-white after:border after:rounded-full after:h-6 after:w-7 after:transition-all"></div>
                            </label>
                        </div>
                    </section>

                    <section>
                        <div id="label-theme-setting" class="text-xl lg:text-2xl font-black mb-6 text-slate-400 uppercase tracking-widest border-l-8 border-blue-400 pl-4">„ÉÜ„Éº„Éû„Ç´„É©„Éº</div>
                        <div class="grid grid-cols-4 gap-4 bg-slate-50 p-6 rounded-3xl">
                            <button onclick="changeTheme('blue')" class="h-16 rounded-2xl bg-blue-500 border-4 border-white shadow-sm hover:scale-105 transition-transform"></button>
                            <button onclick="changeTheme('pink')" class="h-16 rounded-2xl bg-rose-400 border-4 border-white shadow-sm hover:scale-105 transition-transform"></button>
                            <button onclick="changeTheme('green')" class="h-16 rounded-2xl bg-emerald-500 border-4 border-white shadow-sm hover:scale-105 transition-transform"></button>
                            <button onclick="changeTheme('orange')" class="h-16 rounded-2xl bg-orange-500 border-4 border-white shadow-sm hover:scale-105 transition-transform"></button>
                        </div>
                    </section>

                    <section class="flex flex-col items-center pt-4">
                        <button onclick="testSound()" class="bg-slate-800 text-white px-12 py-4 rounded-full font-black text-lg active:scale-95 transition-transform flex items-center gap-4 shadow-xl">
                            <span id="label-sound-test">üîä „Åä„Å®„Çí„Å™„Çâ„Åó„Å¶„Åø„Çã</span>
                        </button>
                    </section>
                </div>

                <!-- Âè≥„Çª„ÇØ„Ç∑„Éß„É≥ -->
                <div class="space-y-12">
                    <section>
                        <div id="label-departure-setting" class="text-xl lg:text-2xl font-black mb-6 text-slate-400 uppercase tracking-widest border-l-8 border-blue-400 pl-4">„Åó„ÇÖ„Å£„Å±„Å§ „Åò„Åã„Çì</div>
                        <div class="flex justify-center bg-slate-50 p-6 rounded-3xl">
                            <input type="time" id="departure-input" value="08:00" onchange="updateDepartureTime()" class="w-full max-w-[240px] p-4 bg-white border-2 border-slate-100 rounded-2xl text-6xl font-black text-center text-blue-600 outline-none shadow-sm tabular-nums">
                        </div>
                    </section>

                    <section>
                        <div id="label-stamp-days" class="text-xl lg:text-2xl font-black mb-6 text-slate-400 uppercase tracking-widest border-l-8 border-blue-400 pl-4">„Çπ„Çø„É≥„Éó„Çí„ÅÇ„Å§„ÇÅ„ÇãÊõúÊó•</div>
                        <div id="day-toggle-list" class="flex flex-wrap justify-between gap-2 bg-slate-50 p-6 rounded-3xl"></div>
                    </section>

                    <section>
                        <div id="label-alarm-setting" class="text-xl lg:text-2xl font-black mb-6 text-slate-400 uppercase tracking-widest border-l-8 border-blue-400 pl-4">„Ç¢„É©„Éº„É†</div>
                        <div id="alarm-list" class="grid grid-cols-2 gap-4 bg-slate-50 p-6 rounded-3xl"></div>
                    </section>
                </div>
            </div>

            <!-- ÂÆå‰∫Ü„Éú„Çø„É≥ -->
            <div class="p-8 border-t flex justify-center shrink-0">
                <button id="close-settings-btn" onclick="toggleSettings()" class="bg-blue-600 text-white px-24 py-4 rounded-full font-black text-2xl shadow-xl hover:brightness-110 active:scale-95 transition-all">Ë®≠ÂÆö„Çí„Åä„Çè„Çã</button>
            </div>
        </div>
    </div>

    <!-- „Ç™„Éº„Éê„Éº„É¨„Ç§ (Á•ù„ÉªÈÄöÁü•) -->
    <div id="celebration-overlay" class="fixed inset-0 z-[100] bg-[#fff0f3]/95 hidden flex flex-col items-center justify-center text-rose-600 p-6 text-center overflow-hidden">
        <div id="confetti-container" class="absolute inset-0 pointer-events-none"></div>
        <div class="relative z-10 flex flex-col items-center">
            <div id="celebration-title-box" class="bg-white rounded-[4rem] p-10 lg:p-20 shadow-2xl mb-10 border-b-[12px] border-rose-50 text-rose-600">
                <h2 id="main-celebration-title" class="text-5xl lg:text-8xl font-black mb-8 tracking-tighter">„Åò„ÇÖ„Çì„Å≥ „Åã„Çì„Çä„Çá„ÅÜÔºÅ</h2>
                <p id="main-celebration-desc" class="text-2xl lg:text-4xl font-bold opacity-90 leading-relaxed">„Åô„Åî„ÅÑÔºÅ„Åú„Çì„Å∂ „Åß„Åç„Åü„Å≠ÔºÅ</p>
            </div>
            <button id="btn-celebration-ok" onclick="closeCelebration()" class="bg-rose-500 text-white px-24 py-6 rounded-full text-4xl lg:text-6xl font-black shadow-2xl active:scale-95 transition-transform">„ÅØ„Éº„ÅÑÔºÅ</button>
        </div>
    </div>

    <div id="alarm-overlay" class="fixed inset-0 z-[200] bg-orange-500 hidden flex flex-col items-center justify-center text-white p-10 text-center animate-pulse">
        <div class="bg-white/20 rounded-full p-10 mb-8"><svg xmlns="http://www.w3.org/2000/svg" width="120" height="120" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></div>
        <h2 id="alarm-title" class="text-6xl lg:text-9xl font-black mb-10 tracking-tight">„ÅÇ„Å® 10„Åµ„ÇìÔºÅ</h2>
        <button onclick="closeAlarm()" id="btn-alarm-ok-box" class="bg-white text-orange-600 px-24 py-8 rounded-full text-5xl lg:text-7xl font-black shadow-2xl active:scale-95 transition-transform">„Çè„Åã„Å£„ÅüÔºÅ</button>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-8 py-4 rounded-full font-bold shadow-2xl transition-all opacity-0 pointer-events-none transform translate-y-4 z-[250] text-lg text-center"></div>

    <script>
        const DICT = {
            kanji: {
                title: "Êúù„ÅÆÊ∫ñÂÇô", remaining: "Âá∫Áô∫„Åæ„Åß", stamp_card: "ÈÄ±Èñì„Çπ„Çø„É≥„Éó", reset: "„ÇÑ„Çä„Å™„Åä„Åô",
                settings: "Ë®≠ÂÆö", display_setting: "Ë°®Á§∫Ë®≠ÂÆö", theme_setting: "„ÉÜ„Éº„Éû„Ç´„É©„Éº",
                departure_setting: "Âá∫Áô∫ÊôÇÈñì", stamp_days: "„Çπ„Çø„É≥„Éó„ÇíÈõÜ„ÇÅ„ÇãÊõúÊó•", alarm_setting: "ÈÄöÁü•Ë®≠ÂÆö",
                sound_test: "üîä Èü≥„ÇíÈ≥¥„Çâ„Åó„Å¶„Åø„Çã", close_settings: "Ë®≠ÂÆö„ÇíÁµÇ„Çè„Çã", done: "ÂÆå‰∫ÜÔºÅ",
                celebration_done: "Ê∫ñÂÇôÂÆå‰∫ÜÔºÅ", celebration_desc: "„Åô„Åî„ÅÑÔºÅÂÖ®ÈÉ®„Åß„Åç„Åü„Å≠ÔºÅ",
                go_out: "„ÅÑ„Å£„Å¶„Çâ„Å£„Åó„ÇÉ„ÅÑÔºÅ", go_out_desc: "Ê∞ó„Çí„Å§„Åë„Å¶Ë°å„Å£„Å¶„Åç„Å¶„Å≠ÔºÅ",
                perfect_week: "üèÜ „Éë„Éº„Éï„Çß„ÇØ„ÉàÔºÅ üèÜ", perfect_desc: "„Åô„Åî„ÅÑÔºÅ‰∏ÄÈÄ±Èñì„ÅÆÊ∫ñÂÇô„Çí„Ç≥„É≥„Éó„É™„Éº„Éà„Åó„Åü„ÇàÔºÅ",
                alarm_time: "Âá∫Áô∫ÔºÅ", alarm_min: "ÂàÜÂâç", alarm_only_undone: "‚ÄªÊú™ÂÆå‰∫ÜÊôÇ",
                days: ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'],
                task_map: { '„ÅØ„Åø„Åå„Åç': 'Ê≠ØÁ£®„Åç', '„ÅÇ„Åï„Åî„ÅØ„Çì': 'ÊúùÈ£ü', '„Éà„Ç§„É¨': '„Éà„Ç§„É¨', '„Åç„Åå„Åà': 'ÁùÄÊõø„Åà', '„Åè„Å§„Åó„Åü': 'Èù¥‰∏ã', '„É©„É≥„Éâ„Çª„É´': '„É©„É≥„Éâ„Çª„É´Ê∫ñÂÇô', '„Åã„Åø„ÅÆ„Åë': 'È´™„ÅÆÊØõ', '„Åß„Åç„ÅüÔºÅ': 'ÂÆå‰∫ÜÔºÅ' }
            },
            kana: {
                title: "„ÅÇ„Åï„ÅÆ„Åò„ÇÖ„Çì„Å≥", remaining: "„Åó„ÇÖ„Å£„Å±„Å§„Åæ„Åß", stamp_card: "„Åó„ÇÖ„ÅÜ„Åã„Çì„Çπ„Çø„É≥„Éó", reset: "„ÇÑ„Çä„Å™„Åä„Åô",
                settings: "„Åõ„Å£„Å¶„ÅÑ", display_setting: "„Å≤„Çá„ÅÜ„Åò „Åõ„Å£„Å¶„ÅÑ", theme_setting: "„ÉÜ„Éº„Éû„Ç´„É©„Éº",
                departure_setting: "„Åó„ÇÖ„Å£„Å±„Å§ „Åò„Åã„Çì", stamp_days: "„Çπ„Çø„É≥„Éó„Çí„ÅÇ„Å§„ÇÅ„ÇãÊõúÊó•", alarm_setting: "„Ç¢„É©„Éº„É†",
                sound_test: "üîä „Åä„Å®„Çí„Å™„Çâ„Åó„Å¶„Åø„Çã", close_settings: "Ë®≠ÂÆö„Çí„Åä„Çè„Çã", done: "„Åß„Åç„ÅüÔºÅ",
                celebration_done: "„Åò„ÇÖ„Çì„Å≥ „Åã„Çì„Çä„Çá„ÅÜÔºÅ", celebration_desc: "„Åô„Åî„ÅÑÔºÅ„Åú„Çì„Å∂ „Åß„Åç„Åü„Å≠ÔºÅ",
                go_out: "„ÅÑ„Å£„Å¶„Çâ„Å£„Åó„ÇÉ„ÅÑÔºÅ", go_out_desc: "„Åç„Çí„Å§„Åë„Å¶ „ÅÑ„Å£„Å¶„Åç„Å¶„Å≠ÔºÅ",
                perfect_week: "üèÜ „Éë„Éº„Éï„Çß„ÇØ„ÉàÔºÅ üèÜ", perfect_desc: "„Åô„Åî„ÅÑÔºÅ‰∏ÄÈÄ±Èñì„ÅÆ„Åò„ÇÖ„Çì„Å≥„Çí„Ç≥„É≥„Éó„É™„Éº„Éà„Åó„Åü„ÇàÔºÅ",
                alarm_time: "„Åó„ÇÖ„Å£„Å±„Å§ÔºÅ", alarm_min: "„Åµ„Çì„Åæ„Åà", alarm_only_undone: "‚Äª„Åæ„Å†„ÅÆ„Å®„Åç",
                days: ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'],
                task_map: {}
            }
        };

        const THEMES = {
            blue: { body: 'bg-blue-50', primary: 'bg-blue-500', primaryDark: 'bg-blue-600', text: 'text-blue-600', border: 'border-blue-100', gradient: 'from-blue-400 to-blue-500' },
            pink: { body: 'bg-rose-50', primary: 'bg-rose-400', primaryDark: 'bg-rose-500', text: 'text-rose-500', border: 'border-rose-100', gradient: 'from-rose-300 to-rose-400' },
            green: { body: 'bg-emerald-50', primary: 'bg-emerald-500', primaryDark: 'bg-emerald-600', text: 'text-emerald-600', border: 'border-emerald-100', gradient: 'from-emerald-400 to-emerald-500' },
            orange: { body: 'bg-orange-50', primary: 'bg-orange-500', primaryDark: 'bg-orange-600', text: 'text-orange-600', border: 'border-orange-100', gradient: 'from-orange-400 to-orange-500' }
        };

        const DEFAULT_TASKS = [
            { id: 1, text: '„ÅØ„Åø„Åå„Åç', completed: false }, { id: 2, text: '„ÅÇ„Åï„Åî„ÅØ„Çì', completed: false },
            { id: 3, text: '„Éà„Ç§„É¨', completed: false }, { id: 4, text: '„Åç„Åå„Åà', completed: false },
            { id: 5, text: '„Åè„Å§„Åó„Åü', completed: false }, { id: 6, text: '„É©„É≥„Éâ„Çª„É´', completed: false },
            { id: 7, text: '„Åã„Åø„ÅÆ„Åë', completed: false }
        ];

        let tasks = [];
        let departureTime = "08:00";
        let isSettingsMode = false;
        let lastDateString = new Date().toDateString(); 
        let alarmConfig = { 30: true, 20: true, 10: true, 5: true, 0: true };
        let lastAlarmTriggered = ""; 
        let draggedItemIndex = null;
        let celebrationShownToday = false; 
        let enabledDays = [false, true, true, true, true, true, false]; 
        let stamps = [false, false, false, false, false, false, false];
        let perfectWeekCount = 0;
        let useKanji = false;
        let theme = 'blue';

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function safeUpdate(id, text) {
            const el = document.getElementById(id);
            if (el) el.textContent = text;
        }

        window.onload = () => {
            loadFromStorage();
            applyTheme();
            updateUIStrings();
            renderTasks();
            renderAlarmSettings();
            renderDayToggles();
            renderStamps();
            startClock();
            document.getElementById('new-task-input')?.addEventListener('keypress', (e) => { if (e.key === 'Enter') addTask(); });
            window.addEventListener('resize', renderTasks);
        };

        function t(key) { return DICT[useKanji ? 'kanji' : 'kana'][key] || key; }
        function taskT(name) { return useKanji ? (DICT.kanji.task_map[name] || name) : name; }

        function toggleKanji() {
            useKanji = document.getElementById('kanji-toggle').checked;
            updateUIStrings(); renderTasks(); renderAlarmSettings(); renderDayToggles(); renderStamps(); saveToStorage();
        }

        function changeTheme(newTheme) {
            theme = newTheme; applyTheme(); renderTasks(); renderDayToggles(); renderAlarmSettings(); saveToStorage();
        }

        function applyTheme() {
            const config = THEMES[theme];
            document.getElementById('app-body').className = `${config.body} h-[100dvh] w-screen p-4 lg:p-5 text-slate-800 transition-colors duration-300`;
            document.getElementById('clock-box').className = `flex-1 bg-gradient-to-br ${config.gradient} rounded-[2.5rem] flex flex-col items-center justify-center text-white border-b-4 border-blue-600/10 shadow-sm`;
            document.getElementById('task-panel').className = `flex-[2] min-h-0 bg-white rounded-[2rem] shadow-sm flex flex-col border-b-8 ${config.border.replace('100','200')} order-2 lg:order-1 overflow-hidden p-5 lg:p-6 border`;
            document.getElementById('label-title').className = `text-2xl lg:text-4xl font-black ${config.text} leading-none`;
            document.getElementById('add-task-btn').className = `${config.primary} text-white p-2 rounded-xl transition-all active:scale-95`;
            document.getElementById('close-settings-btn').className = `${config.primary} text-white px-24 py-4 rounded-full font-black text-2xl shadow-xl hover:brightness-110 active:scale-95 transition-all`;
            
            const toggle = document.getElementById('toggle-bg');
            if(toggle) toggle.style.backgroundColor = document.getElementById('kanji-toggle').checked ? config.primary.replace('bg-', '') : '';
        }

        function updateUIStrings() {
            safeUpdate('label-title', t('title'));
            safeUpdate('label-remaining', t('remaining'));
            safeUpdate('label-stamp', t('stamp_card'));
            safeUpdate('label-reset', t('reset'));
            safeUpdate('label-settings-title', t('settings'));
            safeUpdate('label-display-setting', t('display_setting'));
            safeUpdate('label-theme-setting', t('theme_setting'));
            safeUpdate('label-departure-setting', t('departure_setting'));
            safeUpdate('label-stamp-days', t('stamp_days'));
            safeUpdate('label-alarm-setting', t('alarm_setting'));
            safeUpdate('label-sound-test', t('sound_test'));
            safeUpdate('close-settings-btn', t('close_settings'));
            safeUpdate('btn-alarm-ok-box', useKanji ? "‰∫ÜËß£" : "„Çè„Åã„Å£„ÅüÔºÅ");
            safeUpdate('btn-celebration-ok', useKanji ? "‰∫ÜËß£" : "„ÅØ„Éº„ÅÑÔºÅ");
            const toggle = document.getElementById('kanji-toggle'); if(toggle) toggle.checked = useKanji;
            const depInput = document.getElementById('departure-input'); if(depInput) depInput.value = departureTime;
        }

        function saveToStorage() {
            const data = { tasks, departureTime, saveDate: new Date().toDateString(), alarmConfig, celebrationShownToday, enabledDays, stamps, perfectWeekCount, useKanji, theme };
            localStorage.setItem('morning_routine_v3_data', JSON.stringify(data));
        }

        function loadFromStorage() {
            const savedData = localStorage.getItem('morning_routine_v3_data');
            const today = new Date().toDateString();
            if (savedData) {
                try {
                    const parsed = JSON.parse(savedData);
                    if (parsed.saveDate !== today) { tasks = (parsed.tasks || DEFAULT_TASKS).map(t => ({ ...t, completed: false })); celebrationShownToday = false; } 
                    else { tasks = parsed.tasks || DEFAULT_TASKS; celebrationShownToday = parsed.celebrationShownToday || false; }
                    departureTime = parsed.departureTime || "08:00"; alarmConfig = parsed.alarmConfig || alarmConfig; enabledDays = parsed.enabledDays || enabledDays; stamps = parsed.stamps || stamps; perfectWeekCount = parsed.perfectWeekCount || 0; useKanji = parsed.useKanji || false; theme = parsed.theme || 'blue';
                    safeUpdate('perfect-count', perfectWeekCount);
                } catch (e) { tasks = DEFAULT_TASKS; }
            } else { tasks = DEFAULT_TASKS; }
        }

        function playBeep(freq = 880, duration = 0.1, delay = 0) {
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = 'square'; osc.frequency.setValueAtTime(freq, audioCtx.currentTime + delay); gain.gain.setValueAtTime(0.1, audioCtx.currentTime + delay); gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + delay + duration); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(audioCtx.currentTime + delay); osc.stop(audioCtx.currentTime + delay + duration);
        }

        function speakText(text) { if ('speechSynthesis' in window) { const uttr = new SpeechSynthesisUtterance(text); uttr.lang = 'ja-JP'; uttr.rate = 1.1; window.speechSynthesis.speak(uttr); } }

        function startClock() {
            setInterval(() => {
                const now = new Date(); if (now.toDateString() !== lastDateString) { if (now.getDay() === 1) { stamps = stamps.map(() => false); } lastDateString = now.toDateString(); celebrationShownToday = false; resetAll(); }
                document.getElementById('digital-clock').textContent = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                document.getElementById('digital-seconds').textContent = String(now.getSeconds()).padStart(2, '0');
                updateCountdown(now); checkAlarms(now);
            }, 1000);
        }

        function checkAlarms(now) {
            const [depH, depM] = departureTime.split(':').map(Number); const target = new Date(now); target.setHours(depH, depM, 0, 0); if (target < now) target.setDate(target.getDate() + 1);
            const diffMins = Math.floor((target - now) / 60000); const isAllDone = tasks.length > 0 && tasks.every(t => t.completed);
            [30, 20, 10, 5, 0].forEach(point => { if (diffMins === point && alarmConfig[point]) { const triggerId = `${now.getHours()}:${now.getMinutes()}:${point}`; if (lastAlarmTriggered === triggerId) return; if ([30, 20, 10].includes(point) && isAllDone) return; lastAlarmTriggered = triggerId; showAlarm(point); } });
        }

        function showAlarm(point) {
            const overlay = document.getElementById('alarm-overlay'); const title = document.getElementById('alarm-title'); for(let i=0; i<3; i++) playBeep(880, 0.1, i * 0.2);
            if (point === 0) { title.textContent = t('alarm_time'); speakText(useKanji ? "Âá∫Áô∫„ÅÆÊôÇÈñì„Åß„ÅôÔºÅÂøò„ÇåÁâ©„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÅãÔºü" : "„Åó„ÇÖ„Å£„Å±„Å§„ÅÆ „Åò„Åã„Çì„Å†„ÇàÔºÅ„Çè„Åô„Çå„ÇÇ„ÅÆ„ÅØ„Å™„ÅÑ„Åã„Å™Ôºü"); }
            else { title.textContent = `„ÅÇ„Å® ${point}${t('alarm_min')}`; speakText(useKanji ? `Âá∫Áô∫„Åæ„Åß„ÅÇ„Å®${point}ÂàÜ„Åß„Åô„ÄÇÊ∫ñÂÇô„ÇíÈÄ≤„ÇÅ„Åæ„Åó„Çá„ÅÜÔºÅ` : `„Åó„ÇÖ„Å£„Å±„Å§„Åæ„Åß „ÅÇ„Å®${point}„Åµ„Çì„Å†„Çà„ÄÇ„Åò„ÇÖ„Çì„Å≥„Çí„Åô„Åô„ÇÅ„Çà„ÅÜÔºÅ`); }
            overlay.classList.remove('hidden');
        }

        function closeAlarm() { document.getElementById('alarm-overlay').classList.add('hidden'); window.speechSynthesis.cancel(); }
        function testSound() { audioCtx.resume(); for(let i=0; i<3; i++) playBeep(880, 0.1, i * 0.2); speakText(useKanji ? "„ÉÜ„Çπ„ÉàÊàêÂäüÔºÅÈü≥„ÅåËÅû„Åì„Åà„Åæ„Åô„ÅãÔºü" : "„ÉÜ„Çπ„Éà„Åõ„ÅÑ„Åì„ÅÜÔºÅ„Åä„Å®„Åå„Åç„Åì„Åà„Çã„Åã„Å™Ôºü"); }

        function updateCountdown(now) {
            const [depH, depM] = departureTime.split(':').map(Number); const target = new Date(now); target.setHours(depH, depM, 0, 0); if (target < now) target.setDate(target.getDate() + 1);
            const diff = target - now; const timerElement = document.getElementById('countdown-timer');
            if (diff <= 0 || (target - now) < 1000) { timerElement.innerHTML = `<span class="text-red-500 animate-bounce">${t('alarm_time')}</span>`; } 
            else {
                const totalSecs = Math.floor(diff / 1000); const h = Math.floor(totalSecs / 3600); const m = Math.ceil((totalSecs % 3600) / 60); 
                let html = `<span class="text-[0.6em] mr-2 opacity-50 font-black uppercase tracking-widest leading-none">„ÅÇ„Å®</span>`;
                if (h > 0) html += `<span class="${THEMES[theme].text}">${h}</span><span class="text-[0.5em] mx-1 font-black leading-none">${useKanji ? 'ÊôÇÈñì':'„Åò„Åã„Çì'}</span>`;
                html += `<span class="${THEMES[theme].text}">${m}</span><span class="text-[0.5em] mx-1 font-black leading-none">${useKanji ? 'ÂàÜ':'„Åµ„Çì'}</span>`;
                timerElement.innerHTML = html;
            }
        }

        function renderTasks() {
            const grid = document.getElementById('task-grid'); grid.innerHTML = '';
            const config = THEMES[theme];
            const rows = Math.ceil(tasks.length / 3);
            grid.style.gridTemplateRows = `repeat(${rows}, 1fr)`;
            
            tasks.forEach((task, index) => {
                const card = document.createElement('div'); card.className = 'card-container'; card.setAttribute('data-index', index);
                card.addEventListener('touchstart', (e) => { draggedItemIndex = index; e.currentTarget.classList.add('dragging'); }, {passive: true});
                card.addEventListener('touchend', (e) => {
                    e.currentTarget.classList.remove('dragging'); const touch = e.changedTouches[0]; const targetEl = document.elementFromPoint(touch.clientX, touch.clientY); const targetCard = targetEl?.closest('.card-container');
                    if (targetCard && draggedItemIndex !== null) { const targetIndex = parseInt(targetCard.getAttribute('data-index')); if (draggedItemIndex !== targetIndex) { const item = tasks.splice(draggedItemIndex, 1)[0]; tasks.splice(targetIndex, 0, item); saveToStorage(); renderTasks(); } } draggedItemIndex = null;
                });
                card.innerHTML = `
                    <div class="card-inner ${task.completed ? 'is-flipped' : ''}" onclick="toggleTask(${task.id})">
                        <div class="card-front bg-white ${config.border.replace('100','200')} ${config.text} border-2 transition-all">
                            <span class="text-sm lg:text-xl font-black px-1 text-center pointer-events-none break-all">${taskT(task.text)}</span>
                            ${isSettingsMode ? `<button onclick="event.stopPropagation(); deleteTask(${task.id})" class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full p-1 z-20"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>` : ''}
                        </div>
                        <div class="card-back bg-green-50 border-green-400 text-green-700 border-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" class="text-green-500 mb-1"><polyline points="20 6 9 17 4 12"></polyline></svg>
                            <span class="text-[10px] lg:text-base font-black">${t('done')}</span>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
            updateProgress();
        }

        function renderStamps() {
            const container = document.getElementById('stamp-row'); container.innerHTML = '';
            const daysLabels = t('days');
            [1, 2, 3, 4, 5, 6, 0].forEach(d => {
                if (!enabledDays[d]) return;
                const earned = stamps[d]; const div = document.createElement('div');
                div.className = `flex-1 flex flex-col items-center p-1 lg:p-2 rounded-2xl border ${earned ? 'bg-yellow-50 border-yellow-200' : 'bg-slate-50 border-slate-100'} h-[85%] aspect-square lg:aspect-auto justify-center min-w-0 transition-all flex-shrink`;
                div.innerHTML = `<span class="text-[8px] lg:text-sm font-black ${earned ? 'text-yellow-600' : 'text-slate-400'} mb-1">${daysLabels[d]}</span><span class="text-2xl lg:text-5xl ${earned ? 'earned-stamp' : 'opacity-10 grayscale'}">${earned ? 'üåü' : '‚óØ'}</span>`;
                container.appendChild(div);
            });
        }

        function renderDayToggles() {
            const container = document.getElementById('day-toggle-list'); if(!container) return; container.innerHTML = '';
            const daysLabels = t('days'); const config = THEMES[theme];
            [1, 2, 3, 4, 5, 6, 0].forEach(d => {
                const active = enabledDays[d]; const btn = document.createElement('button');
                btn.className = `p-2 lg:p-4 rounded-xl text-lg font-black border-2 transition-all ${active ? (config.primary + ' text-white ' + config.primaryDark.replace('bg-','border-')) : 'bg-white text-slate-400 border-slate-100'}`;
                btn.textContent = daysLabels[d]; btn.onclick = () => { enabledDays[d] = !enabledDays[d]; renderDayToggles(); renderStamps(); saveToStorage(); };
                container.appendChild(btn);
            });
        }

        function renderAlarmSettings() {
            const list = document.getElementById('alarm-list'); if(!list) return; list.innerHTML = '';
            const minLabel = t('alarm_min'); const undoneLabel = t('alarm_only_undone');
            [30, 20, 10, 5, 0].forEach(p => {
                const active = alarmConfig[p]; const item = document.createElement('div');
                item.className = `flex items-center justify-between px-6 py-4 rounded-2xl border-2 transition-all cursor-pointer ${active ? 'bg-white border-orange-300 shadow-sm' : 'bg-white border-slate-100 opacity-60'}`;
                item.onclick = () => { alarmConfig[p] = !alarmConfig[p]; renderAlarmSettings(); saveToStorage(); };
                const label = p === 0 ? t('alarm_time') : `${p}${minLabel}`;
                item.innerHTML = `<div class="flex flex-col"><span class="font-black text-lg ${active ? 'text-orange-600' : 'text-slate-400'}">${label}</span>${[30, 20, 10].includes(p) ? `<span class="text-xs text-slate-300 font-bold">${undoneLabel}</span>` : ''}</div><div class="text-2xl">${active ? 'üîî' : 'üîï'}</div>`;
                list.appendChild(item);
            });
        }

        function updateProgress() {
            const completed = tasks.filter(t => t.completed).length; const total = tasks.length; const percent = total > 0 ? (completed / total) * 100 : 0;
            const bar = document.getElementById('progress-bar'); if(bar) bar.style.width = `${percent}%`; 
            safeUpdate('progress-text', `${completed} / ${total}`);
            if (total > 0 && completed === total && !isSettingsMode && !celebrationShownToday) { celebrationShownToday = true; handleCompletion(); }
        }

        function handleCompletion() {
            const now = new Date(); const todayIdx = now.getDay(); const [depH, depM] = departureTime.split(':').map(Number);
            const todayLimit = new Date(now); todayLimit.setHours(depH, depM, 0, 0);
            let isPerfectWeek = false; const isOnTime = now < todayLimit;
            if (enabledDays[todayIdx] && isOnTime) { if (!stamps[todayIdx]) { stamps[todayIdx] = true; const req = enabledDays.filter(d => d).length; const ern = stamps.filter((s, i) => s && enabledDays[i]).length; if (req === ern) { isPerfectWeek = true; perfectWeekCount++; safeUpdate('perfect-count', perfectWeekCount); } } }
            renderStamps(); saveToStorage(); showCelebration(isPerfectWeek, isOnTime);
        }

        function showCelebration(isPerfect, isOnTime) {
            const overlay = document.getElementById('celebration-overlay'); const title = document.getElementById('main-celebration-title'); const desc = document.getElementById('main-celebration-desc'); const box = document.getElementById('celebration-title-box');
            if (isPerfect) { title.textContent = t('perfect_week'); desc.textContent = t('perfect_desc'); box.className = "bg-yellow-400 rounded-[3rem] p-10 lg:p-20 shadow-2xl mb-8 text-white border-b-8 border-yellow-500"; speakText(useKanji ? "ÂÆåÁíß„Åß„ÅôÔºÅ„Éë„Éº„Éï„Çß„ÇØ„ÉàÈÅîÊàêÔºÅ‰∏ÄÈÄ±Èñì„ÅÆÊ∫ñÂÇô„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ" : "„Åô„Åî„ÅÑÔºÅ„Éë„Éº„Éï„Çß„ÇØ„ÉàÈÅîÊàêÔºÅ‰∏ÄÈÄ±Èñì„ÅÆ„Åò„ÇÖ„Çì„Å≥„Çí„Ç≥„É≥„Éó„É™„Éº„Éà„Åó„Åü„ÇàÔºÅ"); } 
            else if (isOnTime) { title.textContent = t('celebration_done'); desc.textContent = t('celebration_desc'); box.className = "bg-white rounded-[3rem] p-10 lg:p-20 shadow-2xl mb-8 border-b-8 border-rose-50 text-rose-600"; speakText(useKanji ? "Ê∫ñÂÇôÂÆå‰∫Ü„Åß„ÅôÔºÅ„Åô„Åî„ÅÑ„Åß„Åô„Å≠„ÄÇ„ÇÜ„Å£„Åè„ÇäÈÅé„Åî„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ" : "„Åò„ÇÖ„Çì„Å≥ „Åã„Çì„Çä„Çá„ÅÜÔºÅ„Åô„Åî„ÅÑ„Å≠„ÄÇ„ÇÜ„Å£„Åè„Çä„Åô„Åî„Åó„Å¶„Å≠„ÄÇ"); }
            else { title.textContent = t('go_out'); desc.textContent = t('go_out_desc'); box.className = "bg-white rounded-[3rem] p-10 lg:p-20 shadow-2xl mb-8 border-b-8 border-rose-50 text-rose-600"; speakText(useKanji ? "„ÅÑ„Å£„Å¶„Çâ„Å£„Åó„ÇÉ„ÅÑÔºÅÊ∞ó„Çí„Å§„Åë„Å¶Ë°å„Å£„Å¶„Åç„Å¶„Å≠ÔºÅ" : "„ÅÑ„Å£„Å¶„Çâ„Å£„Åó„ÇÉ„ÅÑÔºÅ„Åç„Çí„Å§„Åë„Å¶ „ÅÑ„Å£„Å¶„Åç„Å¶„Å≠ÔºÅ"); }
            const container = document.getElementById('confetti-container'); container.innerHTML = '';
            for (let i = 0; i < 60; i++) { const c = document.createElement('div'); c.className = 'confetti'; c.style.left = Math.random() * 100 + 'vw'; c.style.backgroundColor = ['#f472b6', '#fb7185', '#fbbf24', '#60a5fa', '#a78bfa'][Math.floor(Math.random() * 5)]; c.style.animationDelay = Math.random() * 3 + 's'; c.style.width = '10px'; c.style.height = '10px'; container.appendChild(c); }
            overlay?.classList.remove('hidden');
        }

        function closeCelebration() { document.getElementById('celebration-overlay')?.classList.add('hidden'); }
        function toggleTask(id) { if (draggedItemIndex !== null) return; const task = tasks.find(t => t.id === id); if (task) { task.completed = !task.completed; if (!task.completed) celebrationShownToday = false; audioCtx.resume(); playBeep(task.completed ? 1100 : 440, 0.05); renderTasks(); saveToStorage(); } }
        function addTask() { const input = document.getElementById('new-task-input'); const text = input?.value.trim(); if (text) { tasks.push({ id: Date.now(), text, completed: false }); celebrationShownToday = false; if(input) input.value = ''; renderTasks(); saveToStorage(); } }
        function deleteTask(id) { tasks = tasks.filter(t => t.id !== id); renderTasks(); saveToStorage(); }
        function resetAll() { tasks = tasks.map(t => ({ ...t, completed: false })); renderTasks(); saveToStorage(); }
        function updateDepartureTime() { departureTime = document.getElementById('departure-input')?.value || departureTime; saveToStorage(); }
        
        function toggleSettings() {
            isSettingsMode = !isSettingsMode;
            const overlay = document.getElementById('settings-overlay');
            const btn = document.getElementById('settings-btn');
            const config = THEMES[theme];
            if (isSettingsMode) {
                overlay?.classList.remove('hidden');
                if(btn) btn.className = `p-3 ${config.primary} text-white rounded-full transition-colors shadow-lg`;
            } else {
                overlay?.classList.add('hidden');
                if(btn) btn.className = `p-3 bg-gray-100 text-slate-400 rounded-full hover:bg-gray-200 transition-colors`;
            }
            renderTasks();
        }

        function showToast(msg) { const t = document.getElementById('toast'); if(!t) return; t.textContent = msg; t.classList.remove('opacity-0', 'translate-y-4', 'pointer-events-none'); setTimeout(() => t.classList.add('opacity-0', 'translate-y-4', 'pointer-events-none'), 3000); }
    </script>
</body>
</html>
