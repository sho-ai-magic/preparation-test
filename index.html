<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>„ÅÇ„Åï„ÅÆ„Åò„ÇÖ„Çì„Å≥„Éû„Çπ„Çø„Éº</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            overflow: hidden;
            touch-action: manipulation;
            transition: background-color 0.3s ease;
        }

        .card-container {
            perspective: 1000px;
            width: 100%;
            height: 100%;
            user-select: none;
            touch-action: none;
        }

        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            cursor: pointer;
        }

        .card-inner.is-flipped {
            transform: rotateY(180deg);
        }

        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 1.25rem;
            border-width: 4px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }

        .card-back {
            transform: rotateY(180deg);
        }

        .dragging {
            opacity: 0.5;
            scale: 0.95;
            z-index: 50;
        }

        @keyframes confetti {
            0% { transform: translateY(0) rotate(0); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            animation: confetti 3s ease-out forwards;
        }

        @keyframes pulse-theme {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .animate-pulse-theme {
            animation: pulse-theme 2s infinite;
        }

        @keyframes shine {
            0% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.1); filter: brightness(1.3); }
            100% { transform: scale(1); filter: brightness(1); }
        }
        .earned-stamp {
            animation: shine 2s infinite;
        }

        .settings-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .settings-scroll::-webkit-scrollbar-track {
            background: transparent;
        }
        .settings-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
    </style>
</head>
<body id="app-body" class="bg-blue-50 h-[100dvh] w-screen p-4 lg:p-6 text-slate-800">

    <div class="flex flex-col lg:flex-row h-full gap-4 lg:gap-6">
        
        <!-- Â∑¶ÂÅ¥„É°„Ç§„É≥: „Çø„Çπ„ÇØÁÆ°ÁêÜ Ôºã „Çπ„Çø„É≥„Éó„Ç´„Éº„Éâ -->
        <div class="flex-[2] flex flex-col gap-4 lg:gap-6 min-h-0 order-2 lg:order-1">
            <!-- Ê∫ñÂÇô„Çø„Çπ„ÇØ„Éë„Éç„É´ -->
            <div id="task-panel" class="flex-1 min-h-0 bg-white rounded-[1.5rem] lg:rounded-[2rem] shadow-xl p-4 lg:p-8 flex flex-col border-b-8 border-blue-200">
                <div class="flex justify-between items-center lg:items-end mb-3 lg:mb-6 shrink-0">
                    <div>
                        <h1 id="label-title" class="text-xl lg:text-4xl font-black text-blue-600 lg:mb-2 leading-none">„ÅÇ„Åï„ÅÆ„Åò„ÇÖ„Çì„Å≥</h1>
                        <div class="flex items-center gap-2 lg:gap-4 mt-1">
                            <div class="w-24 lg:w-64 h-3 lg:h-6 bg-gray-100 rounded-full overflow-hidden border-2 border-gray-50">
                                <div id="progress-bar" class="h-full bg-green-400 transition-all duration-500 ease-out" style="width: 0%"></div>
                            </div>
                            <span id="progress-text" class="font-bold text-xs lg:text-xl text-gray-500">0 / 0</span>
                        </div>
                    </div>
                    <button onclick="toggleSettings()" id="settings-btn" class="p-2 lg:p-3 bg-gray-100 rounded-full hover:bg-gray-200 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
                    </button>
                </div>

                <!-- „Çø„Çπ„ÇØ„Ç∞„É™„ÉÉ„Éâ -->
                <div id="task-grid" class="flex-1 min-h-0 grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-3 gap-2 lg:gap-6 pb-2 overflow-hidden"></div>

                <!-- ‰∏ãÈÉ®Êìç‰Ωú„Ç®„É™„Ç¢ -->
                <div class="mt-2 lg:mt-4 flex flex-col lg:flex-row justify-between items-center gap-2 shrink-0">
                    <div id="add-task-form" class="flex gap-2 items-center w-full lg:w-auto">
                        <input type="text" id="new-task-input" placeholder="„Çø„Çπ„ÇØ„Çí„Å§„ÅÑ„Åã" class="flex-1 lg:w-48 px-3 py-1 lg:px-4 lg:py-2 border-2 border-gray-200 rounded-xl outline-none font-bold text-xs lg:text-base">
                        <button id="add-task-btn" onclick="addTask()" class="bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-xl transition-all active:scale-95">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        </button>
                    </div>
                    <button id="reset-btn" onclick="resetAll()" class="flex items-center gap-2 text-gray-400 hover:text-gray-600 font-bold text-[10px] lg:text-base transition-colors active:scale-95">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></svg>
                        <span id="label-reset">„ÇÑ„Çä„Å™„Åä„Åô</span>
                    </button>
                </div>
            </div>

            <!-- „Çπ„Çø„É≥„Éó„Ç´„Éº„ÉâÔºàÂ∑¶ÂÅ¥„Å´ÁßªÂãïÔºâ -->
            <div id="stamp-card" class="h-20 lg:h-28 bg-white rounded-[1.5rem] lg:rounded-[2rem] shadow-xl p-3 lg:p-4 flex flex-col justify-center border-t-8 lg:border-t-[10px] border-yellow-400 relative overflow-hidden shrink-0">
                <div class="flex justify-between items-center mb-1 px-2">
                    <span id="label-stamp" class="text-[10px] lg:text-xs font-black text-gray-400 uppercase tracking-wider">„Åó„ÇÖ„ÅÜ„Åã„Çì„Çπ„Çø„É≥„Éó</span>
                    <div class="flex items-center gap-1 text-yellow-500 font-black text-xs lg:text-sm">
                        üèÜ <span id="perfect-count">0</span>
                    </div>
                </div>
                <div id="stamp-row" class="flex justify-between gap-1 lg:gap-2 px-1"></div>
            </div>
        </div>

        <!-- Âè≥ÂÅ¥: ÊôÇË®à Ôºã „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥ -->
        <div class="w-full lg:w-1/3 flex flex-row lg:flex-col gap-3 lg:gap-6 shrink-0 order-1 lg:order-2">
            <!-- „Éá„Ç∏„Çø„É´ÊôÇË®à -->
            <div id="clock-box" class="flex-1 lg:flex-none bg-gradient-to-br from-blue-400 to-blue-500 rounded-[1.5rem] lg:rounded-[2rem] shadow-xl p-4 lg:p-8 flex flex-col items-center justify-center text-white border-b-4 lg:border-b-8 border-blue-600/30">
                <div id="digital-clock" class="text-4xl lg:text-7xl font-black drop-shadow-lg tracking-tight leading-none">00:00</div>
                <div id="digital-seconds" class="text-lg lg:text-2xl font-bold opacity-90">00</div>
            </div>

            <!-- Âá∫Áô∫„Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥ -->
            <div id="countdown-card" class="flex-1 lg:flex-1 bg-white rounded-[1.5rem] lg:rounded-[2rem] shadow-xl p-4 lg:p-6 flex flex-col items-center justify-center border-t-8 lg:border-t-[12px] border-orange-400 relative overflow-hidden min-w-0">
                <div class="w-full flex flex-col items-center text-center">
                    <div id="label-remaining" class="text-orange-500 font-black text-sm lg:text-2xl mb-2 lg:mb-4 uppercase tracking-widest">„Åó„ÇÖ„Å£„Å±„Å§„Åæ„Åß</div>
                    <div id="countdown-timer" class="text-xl md:text-2xl lg:text-4xl font-black text-gray-700 leading-tight flex flex-wrap justify-center items-center gap-2">
                        „ÅÇ„Å® -- ÊôÇÈñì -- ÂàÜ -- Áßí
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ÂÖ®ÁîªÈù¢Ë®≠ÂÆö„Ç™„Éº„Éê„Éº„É¨„Ç§ -->
    <div id="settings-overlay" class="fixed inset-0 z-[150] bg-slate-900/60 backdrop-blur-md hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-2xl rounded-[2.5rem] shadow-2xl flex flex-col max-h-[90vh] overflow-hidden border-b-8 border-slate-200">
            <div class="px-8 py-6 border-b flex justify-between items-center bg-slate-50 shrink-0">
                <h3 id="label-settings-title" class="text-2xl font-black text-slate-700 tracking-tight">‚öôÔ∏è „Åõ„Å£„Å¶„ÅÑ</h3>
                <button onclick="toggleSettings()" class="bg-white p-2 rounded-full shadow-sm border hover:bg-gray-100 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-6 lg:p-8 space-y-6 settings-scroll text-sm lg:text-base font-bold">
                <section class="bg-slate-50 p-5 rounded-3xl border-2 border-slate-100">
                    <div id="label-display-setting" class="text-[10px] font-black text-slate-400 mb-3 uppercase tracking-[0.2em] text-center">„Å≤„Çá„ÅÜ„Åò „Åõ„Å£„Å¶„ÅÑ</div>
                    <div class="flex items-center justify-between px-2">
                        <span class="text-xl font-black text-slate-700">„Åã„Çì„Åò (Êº¢Â≠ó)</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="kanji-toggle" onchange="toggleKanji()" class="sr-only peer">
                            <div id="toggle-bg" class="w-16 h-8 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[4px] after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-7 after:transition-all"></div>
                        </label>
                    </div>
                </section>
                <section class="bg-slate-50 p-5 rounded-3xl border-2 border-slate-100">
                    <div id="label-theme-setting" class="text-[10px] font-black text-slate-400 mb-3 uppercase tracking-[0.2em] text-center">„ÉÜ„Éº„Éû„Ç´„É©„Éº</div>
                    <div class="grid grid-cols-4 gap-3">
                        <button onclick="changeTheme('blue')" class="h-14 rounded-2xl bg-blue-500 border-4 border-white shadow-sm flex items-center justify-center text-white text-xs lg:text-sm font-black">„ÅÇ„Åä</button>
                        <button onclick="changeTheme('pink')" class="h-14 rounded-2xl bg-rose-400 border-4 border-white shadow-sm flex items-center justify-center text-white text-xs lg:text-sm font-black">„ÇÇ„ÇÇ</button>
                        <button onclick="changeTheme('green')" class="h-14 rounded-2xl bg-emerald-500 border-4 border-white shadow-sm flex items-center justify-center text-white text-xs lg:text-sm font-black">„Åø„Å©„Çä</button>
                        <button onclick="changeTheme('orange')" class="h-14 rounded-2xl bg-orange-500 border-4 border-white shadow-sm flex items-center justify-center text-white text-xs lg:text-sm font-black">„Å†„ÅÑ„Å†„ÅÑ</button>
                    </div>
                </section>
                <section class="bg-slate-50 p-5 rounded-3xl border-2 border-slate-100">
                    <div id="label-departure-setting" class="text-[10px] font-black text-slate-400 mb-3 uppercase tracking-[0.2em] text-center">„Åó„ÇÖ„Å£„Å±„Å§ „Åò„Åã„Çì</div>
                    <div class="flex justify-center">
                        <input type="time" id="departure-input" value="08:00" onchange="updateDepartureTime()" class="w-full max-w-[240px] p-3 bg-white border-2 border-slate-200 rounded-2xl text-4xl font-black text-center text-blue-600 outline-none shadow-sm">
                    </div>
                </section>
                <section class="bg-slate-50 p-5 rounded-3xl border-2 border-slate-100">
                    <div id="label-stamp-days" class="text-[10px] font-black text-slate-400 mb-3 uppercase tracking-[0.2em] text-center">„Çπ„Çø„É≥„Éó„Çí„ÅÇ„Å§„ÇÅ„ÇãÊõúÊó•</div>
                    <div id="day-toggle-list" class="grid grid-cols-4 sm:grid-cols-7 gap-2"></div>
                </section>
                <section class="bg-slate-50 p-5 rounded-3xl border-2 border-slate-100">
                    <div id="label-alarm-setting" class="text-[10px] font-black text-slate-400 mb-3 uppercase tracking-[0.2em] text-center">„Ç¢„É©„Éº„É† („Å§„ÅÜ„Å° „Åä„Çì)</div>
                    <div id="alarm-list" class="grid grid-cols-1 sm:grid-cols-2 gap-2"></div>
                </section>
                <section class="flex flex-col items-center pt-2">
                    <button id="sound-test-btn" onclick="testSound()" class="bg-slate-800 text-white px-10 py-3 rounded-full font-black text-lg shadow-lg active:scale-95 transition-transform flex items-center gap-2">
                        <span id="label-sound-test">üîä „Åä„Å®„Çí„Å™„Çâ„Åó„Å¶„Åø„Çã</span>
                    </button>
                </section>
            </div>
            <div class="p-6 bg-slate-50 border-t flex justify-center shrink-0">
                <button id="close-settings-btn" onclick="toggleSettings()" class="bg-blue-600 text-white px-16 py-3 rounded-full font-black text-xl shadow-lg active:scale-95">Ë®≠ÂÆö„Çí„Åä„Çè„Çã</button>
            </div>
        </div>
    </div>

    <!-- „ÅäÁ•ù„ÅÑ -->
    <div id="celebration-overlay" class="fixed inset-0 z-[100] bg-[#fff0f3]/95 hidden flex flex-col items-center justify-center text-rose-600 p-6 text-center overflow-hidden">
        <div id="confetti-container" class="absolute inset-0 pointer-events-none"></div>
        <div class="relative z-10 flex flex-col items-center">
            <div id="celebration-title-box" class="bg-white rounded-3xl p-6 lg:p-10 shadow-2xl mb-6 border-b-8 border-rose-100">
                <h2 id="main-celebration-title" class="text-4xl lg:text-7xl font-black mb-4 tracking-tight">„Åò„ÇÖ„Çì„Å≥ „Åã„Çì„Çä„Çá„ÅÜÔºÅ</h2>
                <p id="main-celebration-desc" class="text-lg lg:text-2xl font-bold opacity-90">„Åô„Åî„ÅÑÔºÅ„Åú„Çì„Å∂ „Åß„Åç„Åü„Å≠ÔºÅ</p>
            </div>
            <button id="btn-celebration-ok" onclick="closeCelebration()" class="bg-rose-500 text-white px-16 py-4 rounded-full text-2xl lg:text-4xl font-black shadow-2xl active:scale-95 transition-transform">„ÅØ„Éº„ÅÑÔºÅ</button>
        </div>
    </div>

    <!-- „Ç¢„É©„Éº„É† -->
    <div id="alarm-overlay" class="fixed inset-0 z-[200] bg-orange-500 animate-pulse-theme hidden flex flex-col items-center justify-center text-white p-10 text-center">
        <div class="bg-white/20 rounded-full p-10 mb-8"><svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></div>
        <h2 id="alarm-title" class="text-4xl lg:text-7xl font-black mb-4 tracking-tight">„ÅÇ„Å® 10„Åµ„ÇìÔºÅ</h2>
        <button onclick="closeAlarm()" id="btn-alarm-ok" class="bg-white text-orange-600 px-16 py-6 rounded-full text-3xl lg:text-5xl font-black shadow-2xl active:scale-95">„Çè„Åã„Å£„ÅüÔºÅ</button>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full font-bold shadow-2xl transition-all opacity-0 pointer-events-none transform translate-y-4 z-[250] text-sm"></div>

    <script>
        const DICT = {
            kanji: {
                title: "Êúù„ÅÆÊ∫ñÂÇô", remaining: "Âá∫Áô∫„Åæ„Åß", stamp_card: "ÈÄ±Èñì„Çπ„Çø„É≥„Éó", reset: "„ÇÑ„Çä„Å™„Åä„Åô",
                settings: "Ë®≠ÂÆö", display_setting: "Ë°®Á§∫Ë®≠ÂÆö", theme_setting: "„ÉÜ„Éº„Éû„Ç´„É©„Éº",
                departure_setting: "Âá∫Áô∫ÊôÇÈñì", stamp_days: "„Çπ„Çø„É≥„Éó„ÇíÈõÜ„ÇÅ„ÇãÊõúÊó•", alarm_setting: "„Ç¢„É©„Éº„É† (ÈÄöÁü•Èü≥)",
                sound_test: "üîä Èü≥„ÇíÈ≥¥„Çâ„Åó„Å¶„Åø„Çã", close_settings: "Ë®≠ÂÆö„ÇíÁµÇ„Çè„Çã", done: "ÂÆå‰∫ÜÔºÅ",
                celebration_done: "Ê∫ñÂÇôÂÆå‰∫ÜÔºÅ", celebration_desc: "„Åô„Åî„ÅÑÔºÅÂÖ®ÈÉ®„Åß„Åç„Åü„Å≠ÔºÅ",
                go_out: "„ÅÑ„Å£„Å¶„Çâ„Å£„Åó„ÇÉ„ÅÑÔºÅ", go_out_desc: "Ê∞ó„Çí„Å§„Åë„Å¶Ë°å„Å£„Å¶„Åç„Å¶„Å≠ÔºÅ",
                perfect_week: "üèÜ „Éë„Éº„Éï„Çß„ÇØ„ÉàÔºÅ üèÜ", perfect_desc: "„Åô„Åî„ÅÑÔºÅ‰∏ÄÈÄ±Èñì„ÅÆÊ∫ñÂÇô„Çí„Ç≥„É≥„Éó„É™„Éº„Éà„Åó„Åü„ÇàÔºÅ",
                alarm_time: "Âá∫Áô∫ÔºÅ", alarm_min: "ÂàÜÂâç", alarm_only_undone: "‚ÄªÊú™ÂÆå‰∫Ü„ÅÆÊôÇ",
                days: ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'],
                task_map: {
                    '„ÅØ„Åø„Åå„Åç': 'Ê≠ØÁ£®„Åç', '„ÅÇ„Åï„Åî„ÅØ„Çì': 'ÊúùÈ£ü', '„Éà„Ç§„É¨': '„Éà„Ç§„É¨', '„Åç„Åå„Åà': 'ÁùÄÊõø„Åà',
                    '„Åè„Å§„Åó„Åü': 'Èù¥‰∏ã', '„É©„É≥„Éâ„Çª„É´': '„É©„É≥„Éâ„Çª„É´Ê∫ñÂÇô', '„Åã„Åø„ÅÆ„Åë': 'È´™„ÅÆÊØõ', '„Åß„Åç„ÅüÔºÅ': 'ÂÆå‰∫ÜÔºÅ'
                }
            },
            kana: {
                title: "„ÅÇ„Åï„ÅÆ„Åò„ÇÖ„Çì„Å≥", remaining: "„Åó„ÇÖ„Å£„Å±„Å§„Åæ„Åß", stamp_card: "„Åó„ÇÖ„ÅÜ„Åã„Çì„Çπ„Çø„É≥„Éó", reset: "„ÇÑ„Çä„Å™„Åä„Åô",
                settings: "„Åõ„Å£„Å¶„ÅÑ", display_setting: "„Å≤„Çá„ÅÜ„Åò „Åõ„Å£„Å¶„ÅÑ", theme_setting: "„ÉÜ„Éº„Éû„Ç´„É©„Éº",
                departure_setting: "„Åó„ÇÖ„Å£„Å±„Å§ „Åò„Åã„Çì", stamp_days: "„Çπ„Çø„É≥„Éó„Çí„ÅÇ„Å§„ÇÅ„ÇãÊõúÊó•", alarm_setting: "„Ç¢„É©„Éº„É† („Å§„ÅÜ„Å° „Åä„Çì)",
                sound_test: "üîä „Åä„Å®„Çí„Å™„Çâ„Åó„Å¶„Åø„Çã", close_settings: "Ë®≠ÂÆö„Çí„Åä„Çè„Çã", done: "„Åß„Åç„ÅüÔºÅ",
                celebration_done: "„Åò„ÇÖ„Çì„Å≥ „Åã„Çì„Çä„Çá„ÅÜÔºÅ", celebration_desc: "„Åô„Åî„ÅÑÔºÅ„Åú„Çì„Å∂ „Åß„Åç„Åü„Å≠ÔºÅ",
                go_out: "„ÅÑ„Å£„Å¶„Çâ„Å£„Åó„ÇÉ„ÅÑÔºÅ", go_out_desc: "„Åç„Çí„Å§„Åë„Å¶ „ÅÑ„Å£„Å¶„Åç„Å¶„Å≠ÔºÅ",
                perfect_week: "üèÜ „Éë„Éº„Éï„Çß„ÇØ„ÉàÔºÅ üèÜ", perfect_desc: "„Åô„Åî„ÅÑÔºÅ‰∏ÄÈÄ±Èñì„ÅÆ„Åò„ÇÖ„Çì„Å≥„Çí„Ç≥„É≥„Éó„É™„Éº„Éà„Åó„Åü„ÇàÔºÅ",
                alarm_time: "„Åó„ÇÖ„Å£„Å±„Å§ÔºÅ", alarm_min: "„Åµ„Çì„Åæ„Åà", alarm_only_undone: "‚Äª„Åæ„Å†„ÅÆ„Å®„Åç",
                days: ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'],
                task_map: {}
            }
        };

        const THEMES = {
            blue: { body: 'bg-blue-50', primary: 'bg-blue-500', primaryDark: 'bg-blue-600', text: 'text-blue-600', border: 'border-blue-200', gradient: 'from-blue-400 to-blue-500', clockBorder: 'border-blue-600/30' },
            pink: { body: 'bg-rose-50', primary: 'bg-rose-400', primaryDark: 'bg-rose-500', text: 'text-rose-500', border: 'border-rose-200', gradient: 'from-rose-300 to-rose-400', clockBorder: 'border-rose-500/30' },
            green: { body: 'bg-emerald-50', primary: 'bg-emerald-500', primaryDark: 'bg-emerald-600', text: 'text-emerald-600', border: 'border-emerald-200', gradient: 'from-emerald-400 to-emerald-500', clockBorder: 'border-emerald-600/30' },
            orange: { body: 'bg-orange-50', primary: 'bg-orange-500', primaryDark: 'bg-orange-600', text: 'text-orange-600', border: 'border-orange-200', gradient: 'from-orange-400 to-orange-500', clockBorder: 'border-orange-600/30' }
        };

        const DEFAULT_TASKS = [
            { id: 1, text: '„ÅØ„Åø„Åå„Åç', completed: false }, { id: 2, text: '„ÅÇ„Åï„Åî„ÅØ„Çì', completed: false },
            { id: 3, text: '„Éà„Ç§„É¨', completed: false }, { id: 4, text: '„Åç„Åå„Åà', completed: false },
            { id: 5, text: '„Åè„Å§„Åó„Åü', completed: false }, { id: 6, text: '„É©„É≥„Éâ„Çª„É´', completed: false },
            { id: 7, text: '„Åã„Åø„ÅÆ„Åë', completed: false }
        ];

        let tasks = [];
        let departureTime = "08:00";
        let isSettingsMode = false;
        let lastDateString = new Date().toDateString(); 
        let alarmConfig = { 30: true, 20: true, 10: true, 5: true, 0: true };
        let lastAlarmTriggered = ""; 
        let draggedItemIndex = null;
        let celebrationShownToday = false; 
        let enabledDays = [false, true, true, true, true, true, false]; 
        let stamps = [false, false, false, false, false, false, false];
        let perfectWeekCount = 0;
        let useKanji = false;
        let theme = 'blue';

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        window.onload = () => {
            loadFromStorage();
            applyTheme();
            updateUIStrings();
            renderTasks();
            renderAlarmSettings();
            renderDayToggles();
            renderStamps();
            startClock();
            document.getElementById('new-task-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') addTask(); });
            window.addEventListener('resize', renderTasks);
        };

        function t(key) { return DICT[useKanji ? 'kanji' : 'kana'][key] || key; }
        function taskT(name) { return useKanji ? (DICT.kanji.task_map[name] || name) : name; }

        function toggleKanji() {
            useKanji = document.getElementById('kanji-toggle').checked;
            updateUIStrings(); renderTasks(); renderAlarmSettings(); renderDayToggles(); renderStamps(); saveToStorage();
        }

        function changeTheme(newTheme) {
            theme = newTheme; applyTheme(); renderTasks(); renderDayToggles(); renderAlarmSettings(); saveToStorage();
        }

        function applyTheme() {
            const config = THEMES[theme];
            document.getElementById('app-body').className = `${config.body} h-[100dvh] w-screen p-4 lg:p-6 text-slate-800 transition-colors duration-300`;
            document.getElementById('clock-box').className = `flex-1 lg:flex-none bg-gradient-to-br ${config.gradient} rounded-[1.5rem] lg:rounded-[2rem] shadow-xl p-4 lg:p-6 flex flex-col items-center justify-center text-white border-b-4 lg:border-b-8 ${config.clockBorder}`;
            document.getElementById('task-panel').className = `flex-1 min-h-0 bg-white rounded-[1.5rem] lg:rounded-[2rem] shadow-xl p-4 lg:p-8 flex flex-col border-b-8 ${config.border}`;
            document.getElementById('label-title').className = `text-xl lg:text-4xl font-black ${config.text} lg:mb-2 leading-none`;
            document.getElementById('add-task-btn').className = `${config.primary} hover:${config.primaryDark} text-white p-2 rounded-xl transition-all active:scale-95`;
            document.getElementById('close-settings-btn').className = `${config.primary} text-white px-16 py-3 rounded-full font-black text-xl shadow-lg hover:brightness-110 active:scale-95 transition-all`;
            
            const toggle = document.getElementById('toggle-bg');
            if(document.getElementById('kanji-toggle').checked) {
                toggle.style.backgroundColor = config.primary.replace('bg-', '');
            } else {
                toggle.style.backgroundColor = '';
            }
        }

        function updateUIStrings() {
            document.getElementById('label-title').textContent = t('title');
            document.getElementById('label-remaining').textContent = t('remaining');
            document.getElementById('label-stamp').textContent = t('stamp_card');
            document.getElementById('label-reset').textContent = t('reset');
            document.getElementById('label-settings-title').textContent = t('settings');
            document.getElementById('label-display-setting').textContent = t('display_setting');
            document.getElementById('label-theme-setting').textContent = t('theme_setting');
            document.getElementById('label-departure-setting').textContent = t('departure_setting');
            document.getElementById('label-stamp-days').textContent = t('stamp_days');
            document.getElementById('label-alarm-setting').textContent = t('alarm_setting');
            document.getElementById('label-sound-test').textContent = t('sound_test');
            document.getElementById('close-settings-btn').textContent = t('close_settings');
            document.getElementById('btn-alarm-ok').textContent = useKanji ? "‰∫ÜËß£" : "„Çè„Åã„Å£„ÅüÔºÅ";
            document.getElementById('btn-celebration-ok').textContent = useKanji ? "‰∫ÜËß£" : "„ÅØ„Éº„ÅÑÔºÅ";
            document.getElementById('kanji-toggle').checked = useKanji;
            document.getElementById('departure-input').className = `w-full max-w-[240px] p-3 bg-white border-2 border-slate-200 rounded-2xl text-4xl font-black text-center ${THEMES[theme].text} focus:border-blue-400 outline-none shadow-sm`;
        }

        function saveToStorage() {
            const data = { tasks, departureTime, saveDate: new Date().toDateString(), alarmConfig, celebrationShownToday, enabledDays, stamps, perfectWeekCount, useKanji, theme };
            localStorage.setItem('morning_routine_v3_data', JSON.stringify(data));
        }

        function loadFromStorage() {
            const savedData = localStorage.getItem('morning_routine_v3_data');
            const today = new Date().toDateString();
            if (savedData) {
                try {
                    const parsed = JSON.parse(savedData);
                    if (parsed.saveDate !== today) { tasks = (parsed.tasks || DEFAULT_TASKS).map(t => ({ ...t, completed: false })); celebrationShownToday = false; } 
                    else { tasks = parsed.tasks || DEFAULT_TASKS; celebrationShownToday = parsed.celebrationShownToday || false; }
                    departureTime = parsed.departureTime || "08:00"; alarmConfig = parsed.alarmConfig || alarmConfig; enabledDays = parsed.enabledDays || enabledDays; stamps = parsed.stamps || stamps; perfectWeekCount = parsed.perfectWeekCount || 0; useKanji = parsed.useKanji || false; theme = parsed.theme || 'blue';
                    document.getElementById('departure-input').value = departureTime; document.getElementById('perfect-count').textContent = perfectWeekCount;
                } catch (e) { tasks = DEFAULT_TASKS; }
            } else { tasks = DEFAULT_TASKS; }
        }

        function playBeep(freq = 880, duration = 0.1, delay = 0) {
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = 'square'; osc.frequency.setValueAtTime(freq, audioCtx.currentTime + delay); gain.gain.setValueAtTime(0.1, audioCtx.currentTime + delay); gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + delay + duration); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(audioCtx.currentTime + delay); osc.stop(audioCtx.currentTime + delay + duration);
        }

        function speakText(text) { if ('speechSynthesis' in window) { const uttr = new SpeechSynthesisUtterance(text); uttr.lang = 'ja-JP'; uttr.rate = 1.1; window.speechSynthesis.speak(uttr); } }

        function startClock() {
            setInterval(() => {
                const now = new Date(); if (now.toDateString() !== lastDateString) { if (now.getDay() === 1) { stamps = stamps.map(() => false); } lastDateString = now.toDateString(); celebrationShownToday = false; resetAll(); }
                document.getElementById('digital-clock').textContent = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                document.getElementById('digital-seconds').textContent = String(now.getSeconds()).padStart(2, '0');
                updateCountdown(now); checkAlarms(now);
            }, 1000);
        }

        function checkAlarms(now) {
            const [depH, depM] = departureTime.split(':').map(Number); const target = new Date(now); target.setHours(depH, depM, 0, 0); if (target < now) target.setDate(target.getDate() + 1);
            const diffMins = Math.floor((target - now) / 60000); const isAllDone = tasks.length > 0 && tasks.every(t => t.completed);
            [30, 20, 10, 5, 0].forEach(point => { if (diffMins === point && alarmConfig[point]) { const triggerId = `${now.getHours()}:${now.getMinutes()}:${point}`; if (lastAlarmTriggered === triggerId) return; if ([30, 20, 10].includes(point) && isAllDone) return; lastAlarmTriggered = triggerId; showAlarm(point); } });
        }

        function showAlarm(point) {
            const overlay = document.getElementById('alarm-overlay'); const title = document.getElementById('alarm-title'); for(let i=0; i<3; i++) playBeep(880, 0.1, i * 0.2);
            if (point === 0) { title.textContent = t('alarm_time'); speakText(useKanji ? "Âá∫Áô∫„ÅÆÊôÇÈñì„Åß„ÅôÔºÅÂøò„ÇåÁâ©„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÅãÔºü" : "„Åó„ÇÖ„Å£„Å±„Å§„ÅÆ „Åò„Åã„Çì„Å†„ÇàÔºÅ„Çè„Åô„Çå„ÇÇ„ÅÆ„ÅØ„Å™„ÅÑ„Åã„Å™Ôºü"); }
            else { title.textContent = `„ÅÇ„Å® ${point}${t('alarm_min')}`; speakText(useKanji ? `Âá∫Áô∫„Åæ„Åß„ÅÇ„Å®${point}ÂàÜ„Åß„Åô„ÄÇÊ∫ñÂÇô„ÇíÈÄ≤„ÇÅ„Åæ„Åó„Çá„ÅÜÔºÅ` : `„Åó„ÇÖ„Å£„Å±„Å§„Åæ„Åß „ÅÇ„Å®${point}„Åµ„Çì„Å†„Çà„ÄÇ„Åò„ÇÖ„Çì„Å≥„Çí„Åô„Åô„ÇÅ„Çà„ÅÜÔºÅ`); }
            overlay.classList.remove('hidden');
        }

        function closeAlarm() { document.getElementById('alarm-overlay').classList.add('hidden'); window.speechSynthesis.cancel(); }
        function testSound() { audioCtx.resume(); for(let i=0; i<3; i++) playBeep(880, 0.1, i * 0.2); speakText(useKanji ? "„ÉÜ„Çπ„ÉàÊàêÂäüÔºÅÈü≥„ÅåËÅû„Åì„Åà„Åæ„Åô„ÅãÔºü" : "„ÉÜ„Çπ„Éà„Åõ„ÅÑ„Åì„ÅÜÔºÅ„Åä„Å®„Åå„Åç„Åì„Åà„Çã„Åã„Å™Ôºü"); }

        function updateCountdown(now) {
            const [depH, depM] = departureTime.split(':').map(Number); const target = new Date(now); target.setHours(depH, depM, 0, 0); if (target < now) target.setDate(target.getDate() + 1);
            const diff = target - now; const timerElement = document.getElementById('countdown-timer');
            if (diff <= 0 || (target - now) < 1000) { timerElement.innerHTML = `<span class="text-red-500 animate-bounce">${t('alarm_time')}</span>`; } 
            else {
                const totalSecs = Math.floor(diff / 1000); const h = Math.floor(totalSecs / 3600); const m = Math.floor((totalSecs % 3600) / 60); const s = totalSecs % 60;
                let html = `<span class="text-[0.6em] mr-1 opacity-50 font-black uppercase tracking-widest">„ÅÇ„Å®</span>`;
                if (h > 0) html += `<span class="${THEMES[theme].text}">${h}</span><span class="text-[0.5em] mx-0.5 font-black">${useKanji ? 'ÊôÇÈñì':'„Åò„Åã„Çì'}</span>`;
                html += `<span class="${THEMES[theme].text}">${m}</span><span class="text-[0.5em] mx-0.5 font-black">${useKanji ? 'ÂàÜ':'„Åµ„Çì'}</span><span class="text-slate-400 font-bold">${s}</span><span class="text-[0.5em] mx-0.5 font-black text-slate-400">${useKanji ? 'Áßí':'„Å≥„Çá„ÅÜ'}</span>`;
                timerElement.innerHTML = html;
            }
        }

        function renderTasks() {
            const grid = document.getElementById('task-grid'); grid.innerHTML = '';
            const cols = window.innerWidth >= 640 ? 3 : 2; const rows = Math.ceil(tasks.length / cols);
            grid.style.gridTemplateRows = `repeat(${rows}, minmax(0, 1fr))`;
            const config = THEMES[theme];
            tasks.forEach((task, index) => {
                const card = document.createElement('div'); card.className = 'card-container'; card.setAttribute('data-index', index);
                card.addEventListener('touchstart', (e) => { draggedItemIndex = index; e.currentTarget.classList.add('dragging'); }, {passive: true});
                card.addEventListener('touchend', (e) => {
                    e.currentTarget.classList.remove('dragging'); const touch = e.changedTouches[0]; const targetEl = document.elementFromPoint(touch.clientX, touch.clientY); const targetCard = targetEl?.closest('.card-container');
                    if (targetCard && draggedItemIndex !== null) { const targetIndex = parseInt(targetCard.getAttribute('data-index')); if (draggedItemIndex !== targetIndex) { const item = tasks.splice(draggedItemIndex, 1)[0]; tasks.splice(targetIndex, 0, item); saveToStorage(); renderTasks(); } } draggedItemIndex = null;
                });
                card.innerHTML = `
                    <div class="card-inner ${task.completed ? 'is-flipped' : ''}" onclick="toggleTask(${task.id})">
                        <div class="card-front bg-white ${config.border} ${config.text}">
                            <span class="text-sm lg:text-xl font-black px-1 text-center pointer-events-none">${taskT(task.text)}</span>
                        </div>
                        <div class="card-back bg-green-100 border-green-400 text-green-700">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" class="text-green-500 mb-1"><polyline points="20 6 9 17 4 12"></polyline></svg>
                            <span class="text-[10px] lg:text-base font-black">${t('done')}</span>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
            updateProgress();
        }

        function renderStamps() {
            const container = document.getElementById('stamp-row'); container.innerHTML = '';
            const daysLabels = t('days');
            [1, 2, 3, 4, 5, 6, 0].forEach(d => {
                if (!enabledDays[d]) return;
                const earned = stamps[d]; const div = document.createElement('div');
                div.className = `flex-1 flex flex-col items-center p-1 rounded-lg border ${earned ? 'bg-yellow-50 border-yellow-200' : 'bg-gray-50 border-gray-100'}`;
                div.innerHTML = `<span class="text-[8px] lg:text-[10px] font-bold ${earned ? 'text-yellow-600' : 'text-gray-400'}">${daysLabels[d]}</span><span class="text-lg lg:text-2xl ${earned ? 'earned-stamp' : 'opacity-20 grayscale'}">${earned ? 'üåü' : '‚óØ'}</span>`;
                container.appendChild(div);
            });
        }

        function renderDayToggles() {
            const container = document.getElementById('day-toggle-list'); if(!container) return; container.innerHTML = '';
            const daysLabels = t('days'); const config = THEMES[theme];
            [1, 2, 3, 4, 5, 6, 0].forEach(d => {
                const active = enabledDays[d]; const btn = document.createElement('button');
                btn.className = `p-2 rounded-xl text-xs font-black border-2 transition-all ${active ? (config.primary + ' text-white ' + config.primaryDark.replace('bg-','border-')) : 'bg-white text-slate-400 border-slate-100'}`;
                btn.textContent = daysLabels[d]; btn.onclick = () => { enabledDays[d] = !enabledDays[d]; renderDayToggles(); renderStamps(); saveToStorage(); };
                container.appendChild(btn);
            });
        }

        function renderAlarmSettings() {
            const list = document.getElementById('alarm-list'); if(!list) return; list.innerHTML = '';
            const minLabel = t('alarm_min'); const undoneLabel = t('alarm_only_undone');
            [30, 20, 10, 5, 0].forEach(p => {
                const active = alarmConfig[p]; const item = document.createElement('div');
                item.className = `flex items-center justify-between px-4 py-2 rounded-2xl border-2 transition-all cursor-pointer ${active ? 'bg-white border-orange-300 shadow-sm' : 'bg-white border-slate-100 opacity-60'}`;
                item.onclick = () => { alarmConfig[p] = !alarmConfig[p]; renderAlarmSettings(); saveToStorage(); };
                const label = p === 0 ? t('alarm_time') : `${p}${minLabel}`;
                item.innerHTML = `<div class="flex flex-col"><span class="font-black text-sm ${active ? 'text-orange-600' : 'text-slate-400'}">${label}</span>${[30, 20, 10].includes(p) ? `<span class="text-[8px] text-slate-300 font-bold">${undoneLabel}</span>` : ''}</div><div class="text-lg">${active ? 'üîî' : 'üîï'}</div>`;
                list.appendChild(item);
            });
        }

        function updateProgress() {
            const completed = tasks.filter(t => t.completed).length; const total = tasks.length; const percent = total > 0 ? (completed / total) * 100 : 0;
            document.getElementById('progress-bar').style.width = `${percent}%`; document.getElementById('progress-text').textContent = `${completed} / ${total}`;
            if (total > 0 && completed === total && !isSettingsMode && !celebrationShownToday) { celebrationShownToday = true; handleCompletion(); }
        }

        function handleCompletion() {
            const now = new Date(); const todayIdx = now.getDay(); const [depH, depM] = departureTime.split(':').map(Number);
            const todayLimit = new Date(now); todayLimit.setHours(depH, depM, 0, 0);
            let isPerfectWeek = false; const isOnTime = now < todayLimit;
            if (enabledDays[todayIdx] && isOnTime) { if (!stamps[todayIdx]) { stamps[todayIdx] = true; const req = enabledDays.filter(d => d).length; const ern = stamps.filter((s, i) => s && enabledDays[i]).length; if (req === ern) { isPerfectWeek = true; perfectWeekCount++; document.getElementById('perfect-count').textContent = perfectWeekCount; } } }
            renderStamps(); saveToStorage(); showCelebration(isPerfectWeek, isOnTime);
        }

        function showCelebration(isPerfect, isOnTime) {
            const overlay = document.getElementById('celebration-overlay'); const title = document.getElementById('main-celebration-title'); const desc = document.getElementById('main-celebration-desc'); const box = document.getElementById('celebration-title-box');
            if (isPerfect) { title.textContent = t('perfect_week'); desc.textContent = t('perfect_desc'); box.className = "bg-yellow-400 rounded-3xl p-10 shadow-2xl mb-6 text-white border-b-8 border-yellow-500"; speakText(useKanji ? "ÂÆåÁíß„Åß„ÅôÔºÅ„Éë„Éº„Éï„Çß„ÇØ„ÉàÈÅîÊàêÔºÅ‰∏ÄÈÄ±Èñì„ÅÆÊ∫ñÂÇô„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ" : "„Åô„Åî„ÅÑÔºÅ„Éë„Éº„Éï„Çß„ÇØ„ÉàÈÅîÊàêÔºÅ‰∏ÄÈÄ±Èñì„ÅÆ„Åò„ÇÖ„Çì„Å≥„Çí„Ç≥„É≥„Éó„É™„Éº„Éà„Åó„Åü„ÇàÔºÅ"); } 
            else if (isOnTime) { title.textContent = t('celebration_done'); desc.textContent = t('celebration_desc'); box.className = "bg-white rounded-3xl p-10 shadow-2xl mb-6 border-b-8 border-rose-100 text-rose-600"; speakText(useKanji ? "Ê∫ñÂÇôÂÆå‰∫Ü„Åß„ÅôÔºÅ„Åô„Åî„ÅÑ„Åß„Åô„Å≠„ÄÇ„ÇÜ„Å£„Åè„ÇäÈÅé„Åî„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ" : "„Åò„ÇÖ„Çì„Å≥ „Åã„Çì„Çä„Çá„ÅÜÔºÅ„Åô„Åî„ÅÑ„Å≠„ÄÇ„ÇÜ„Å£„Åè„Çä„Åô„Åî„Åó„Å¶„Å≠„ÄÇ"); }
            else { title.textContent = t('go_out'); desc.textContent = t('go_out_desc'); box.className = "bg-white rounded-3xl p-10 shadow-2xl mb-6 border-b-8 border-rose-100 text-rose-600"; speakText(useKanji ? "„ÅÑ„Å£„Å¶„Çâ„Å£„Åó„ÇÉ„ÅÑÔºÅÊ∞ó„Çí„Å§„Åë„Å¶Ë°å„Å£„Å¶„Åç„Å¶„Å≠ÔºÅ" : "„ÅÑ„Å£„Å¶„Çâ„Å£„Åó„ÇÉ„ÅÑÔºÅ„Åç„Çí„Å§„Åë„Å¶ „ÅÑ„Å£„Å¶„Åç„Å¶„Å≠ÔºÅ"); }
            const container = document.getElementById('confetti-container'); container.innerHTML = '';
            for (let i = 0; i < 60; i++) { const c = document.createElement('div'); c.className = 'confetti'; c.style.left = Math.random() * 100 + 'vw'; c.style.backgroundColor = ['#f472b6', '#fb7185', '#fbbf24', '#60a5fa', '#a78bfa'][Math.floor(Math.random() * 5)]; c.style.animationDelay = Math.random() * 3 + 's'; c.style.width = '10px'; c.style.height = '10px'; container.appendChild(c); }
            overlay.classList.remove('hidden');
        }

        function closeCelebration() { document.getElementById('celebration-overlay').classList.add('hidden'); }
        function toggleTask(id) { if (draggedItemIndex !== null) return; const task = tasks.find(t => t.id === id); if (task) { task.completed = !task.completed; if (!task.completed) celebrationShownToday = false; audioCtx.resume(); playBeep(task.completed ? 1100 : 440, 0.05); renderTasks(); saveToStorage(); } }
        function addTask() { const input = document.getElementById('new-task-input'); const text = input.value.trim(); if (text) { tasks.push({ id: Date.now(), text, completed: false }); celebrationShownToday = false; input.value = ''; renderTasks(); saveToStorage(); } }
        function deleteTask(id) { tasks = tasks.filter(t => t.id !== id); renderTasks(); saveToStorage(); }
        function resetAll() { tasks = tasks.map(t => ({ ...t, completed: false })); renderTasks(); saveToStorage(); }
        function updateDepartureTime() { departureTime = document.getElementById('departure-input').value; saveToStorage(); }
        function toggleSettings() { isSettingsMode = !isSettingsMode; const overlay = document.getElementById('settings-overlay'); const btn = document.getElementById('settings-btn'); const config = THEMES[theme]; if (isSettingsMode) { overlay.classList.remove('hidden'); btn.className = `p-2 lg:p-3 ${config.primary} text-white rounded-full transition-colors shadow-lg`; } else { overlay.classList.add('hidden'); btn.className = `p-2 lg:p-3 bg-gray-100 rounded-full hover:bg-gray-200 transition-colors`; } renderTasks(); }
        function showToast(msg) { const t = document.getElementById('toast'); t.textContent = msg; t.classList.remove('opacity-0', 'translate-y-4', 'pointer-events-none'); setTimeout(() => t.classList.add('opacity-0', 'translate-y-4', 'pointer-events-none'), 3000); }
    </script>
</body>
</html>
